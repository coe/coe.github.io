define(["Ti/_/declare","Ti/_/Evented","Ti/_/style","Ti/UI"],function(e,t,i,r){function o(){r._layoutInProgress?h.once(r,"postlayout",function(){requestAnimationFrame(n)}):requestAnimationFrame(n)}function n(){var e,t,i,r,n,a,s,d,h,p,f,g,v,T,_=c();l=0;for(e in I)for(t=I[e],n=0;n<t.length;n++)if(i=t[n],!i.paused){if(p=i.duration?Math.min(1,(_-i.ts)/i.duration):1,f=u[i.curve](i.forward?p:1-p),r=i.elem,r._isAttachedToActiveWin())for(g in i.props){if(T=i.props[g],d=T[0],h=T[1],1===p&&(v=i.forward?h:d),"transform"===g){if(1!==p){for(v=[],s=d.length,a=0;s>a;a++)(12>a||a>14)&&(v[a]=d[a]+(h[a]-d[a])*f);l=1}16===v.length?(a=v.splice(12),v="matrix3d("+v.join(",")+") rotate3d("+a.join(",")+"deg)"):(a=v.pop(),v="matrix("+v.join(",")+") rotate("+a+"deg)"),g=y}else if(U[g]){if(1!==p){for(v=[],a=0;4>a;a++)v[a]=Math.floor(d[a]+(h[a]-d[a])*f);l=1}v="rgba("+v.join(",")+")"}else w[g]&&(1!==p&&(v=d+(h-d)*f,l=1),v="opacity"===g?v:v+"px");i.prev!==v&&(r.domNode.style[g]=v),i.prev=v}1===p&&(i.ts=_,i.duration&&i.reverse&&i.forward?(i.forward=0,l=1):i.repeat-->0?l=i.forward=1:(t.splice(n--,1),i.promise.resolve(),t.length||I[e].activeCount||delete I[e]))}l&&o()}function a(e){var t,i,r,o;if(e=e.trim().toLowerCase(),"#"===e.charAt(0))i=4==e.length?4:8,isNaN(e=Number("0x"+e.substring(1)))||(r=(1<<i)-1,o=4===i?17:1,o=[(e>>2*i&r)*o,(e>>i&r)*o,(e&r)*o,1]);else if(t=e.match(T))for(o=t[1].split(/\s*,\s*/),t=0;3>t;)o[t++]|=0;else C&&(o=C[e]);return o?(o[3]=isNaN(t=parseFloat(o[3]))?1:Math.min(Math.max(t,0),1),o):void 0}function s(e,t,i,r){var o,n,a,s,l=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];if(e)if(o=e[1],n=e[2].split(","),a=n.length,o&&16===a)for(s=0;12>s;s++)l[s]=n[s];else o||6!==a||(l[0]=n[0],l[1]=n[1],l[4]=n[2],l[5]=n[3],l[3]=n[4],l[7]=n[5]);if(t)if(o=t[1],n=t[2].split(","),a=n.length,o&&4===a)for(s=0;4>s;s++)l[12+s]=n[s];else o||1!==a||(l[14]=1,l[15]=n[0]);return i=2===r?[i.a,i.b,0,i.tx,i.c,i.d,0,i.ty,0,0,1,0,0,0,1,i.rotation]:[i.m11,i.m12,i.m13,i.m14,i.m21,i.m22,i.m23,i.m24,i.m31,i.m32,i.m33,i.m34,i.rotationX,i.rotationY,i.rotationZ,i.rotation],[l,i]}for(var l,u=[function(e){return e*=2,1>e?Math.pow(e,2)/2:-1*(--e*(e-2)-1)/2},function(e){return Math.pow(e,2)},function(e){return e*(e-2)*-1},function(e){return e}],d=window,c=Date.now,h=require.on,p=0,f=["ms","moz","webkit","o"],g=f.length,v={autoreverse:1,bottom:1,center:1,curve:1,delay:1,duration:1,repeat:1,right:1,visible:1,zIndex:1},U={backgroundColor:1,color:1},w={height:1,left:1,opacity:1,top:1,width:1},T=/^rgba?\(([\s\.,0-9]+)\)/,_=/3d/,m=/^Ti\.UI\.(2|3)DMatrix$/,b=/matrix(3d)?\(([^\)]*)/,E=/rotate(3d)?\(([^\)]*)/,I={},y=i.discover("transform"),C=require(require.config.ti.colorsModule),S=e("Ti.UI.Animation",t,{properties:{autoreverse:void 0,backgroundColor:void 0,bottom:void 0,center:void 0,color:void 0,curve:void 0,delay:void 0,duration:void 0,height:void 0,left:void 0,opacity:void 0,repeat:void 0,right:void 0,top:void 0,transform:void 0,visible:void 0,width:void 0,zIndex:void 0}});--g>=0&&!d.requestAnimationFrame;)d.requestAnimationFrame=d[f[g]+"RequestAnimationFrame"];return d.requestAnimationFrame||(d.requestAnimationFrame=function(e){var t=c(),i=Math.max(0,16-(t-p)),r=window.setTimeout(function(){e(t+i)},i);return p=t+i,r}),S._play=function(e,t){function r(){if(!e._alive||!e._isAttachedToActiveWin())return void f.activeCount--;var r,n,h,T,I,y,C,S,L,A,x={},O=e._parent._layout.calculateAnimation(e,t);for(h in g)if(y=g[h],!v[h]&&void 0!==y){for(r=0;r<f.length;r++)delete f[r].props[h],require.isEmpty(f[r].props)&&f.splice(r--,1);if(T=i.get(e.domNode,h),U[h])T=a(T),y=a(y),(y>T||T>y)&&(x[h]=[T,y]);else if(w[h])isNaN(T=parseFloat(T))&&"opacity"===h&&(T=1),y=h in O?O[h]:y,T!==y&&(x[h]=[T,y]);else if("transform"===h&&(I=y.declaredClass.match(m))){if(I=0|I[1],L=T.match(b),A=T.match(E),_.test(T)||3===I)C=s(L,A,y,I),T=C[0],y=C[1];else if(2===I){if(T=[1,0,0,1,0,0,0],L)for(S=L[2].split(","),n=Math.min(6,S.length),r=0;n>r;r++)T[r]=parseFloat(S[r]);A&&(S=A[2].split(","),S.length&&(T[6]=parseFloat(S[0]))),y=[y.a,y.b,y.c,y.d,y.tx,y.ty,y.rotation],C=[T,y]}(y>T||T>y)&&(x[h]=C)}}f.push({id:p,elem:e,promise:d,props:x,ts:c(),reverse:!!g.autoreverse,forward:1,curve:Math.max(0,Math.min(u.length-1,0|g.curve)),duration:0|g.duration,repeat:!!g.repeat}),t.fireEvent("start"),l||(l=1,o())}function n(){for(var e=0,t=f&&f.length;t>e;e++)if(f[e].id===p)return f[e]}var d=new require.Promise,h=e.widgetId,p=1e9*Math.random()|0,f=I[h]=I[h]||[],g=t.__values__.properties,T=0|g.delay,y=!!g.visible,C=g.zIndex;return f.activeCount=~~f.activeCount+1,setTimeout(r,T||0),d.source=e,d.animation=t,d.pause=function(){var e=n();return e=!!e&&(e.paused||(e.paused=c())),t.fireEvent("pause"),e},d.resume=function(){var e=n();return e&&(e.paused&&(e.ts+=c()-e.paused),l||(l=1,o())),e=!!e&&!(e.paused=0),t.fireEvent("resume"),e},d.cancel=function(e){for(var r,o,n,a=0,s=f&&f.length,l=!1;s>a;a++)if(f[a].id===p){if(r=f[a],e){n=r.elem.domNode;for(o in r.props)s=r.props[o][0],i.set(n,o,w[o]&&"opacity"!==o?s+"px":s)}f.splice(a,1),f.length||f.activeCount||delete I[h],l=!0;break}return f.activeCount--,t.fireEvent("cancel"),l},d.then(function(){void 0!==g.visible&&(e.visible=y),void 0!==g.zIndex&&(e.zIndex=C),f.activeCount--,t.fireEvent("complete")})},S});