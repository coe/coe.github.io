define(["Ti/_/Evented","Ti/_/lang","Ti/Network"],function(e,t,i){function r(e){var t=h(window,"deviceorientation",function(i){t(),e(i)})}function o(e){return function(t){l={heading:{accuracy:t.webkitCompassAccuracy,magneticHeading:t.webkitCompassHeading},success:!0,timestamp:Date.now()},s.fireEvent("heading",l),e&&e(l)}}function n(e){return function(t){var i="coords"in t;c={success:i},i?c.coords=t.coords:c.code=t.code,s.fireEvent("location",c),e&&e(c)}}function a(){return{enableHighAccuracy:s.accuracy===s.ACCURACY_HIGH,timeout:s.MobileWeb.locationTimeout,maximumAge:s.MobileWeb.maximumLocationAge}}var s,l,u,d,c,h=require.on,p=!1,g=0,f=0,U=t.isDef;return r(function(e){U(e.webkitCompassHeading)&&(p=!0)}),s=t.setObject("Ti.Geolocation",e,{getCurrentPosition:function(e){s.locationServicesEnabled&&navigator.geolocation.getCurrentPosition(n(e),n(e),a())},getCurrentHeading:function(e){p&&(l&&Date.now()-l.timestamp<s.maximumHeadingAge?e(l):r(o(e)))},forwardGeocoder:function(e,t){if(require.is(e,"String")){var r=i.createHTTPClient({onload:function(){var e=this.responseText.split(",");t({success:!0,code:0,latitude:parseFloat(e[2]),longitude:parseFloat(e[3])})},onerror:function(e){t({success:!1,code:-1,error:e+""})},timeout:s.MobileWeb.forwardGeocoderTimeout});r.open("GET","http://api.appcelerator.com/p/v1/geo?d=f&q="+escape(e)),r.send()}},reverseGeocoder:function(e,t,r){if(U(e)&&U(t)){var o=i.createHTTPClient({onload:function(){r(JSON.parse(this.responseText))},onerror:function(){r({success:!1})},timeout:s.MobileWeb.forwardGeocoderTimeout});o.open("GET","http://api.appcelerator.com/p/v1/geo?d=r&q="+e+","+t),o.send()}},addEventListener:function(t,i){switch(t){case"heading":p&&(g++,1===g&&(u=h(window,"deviceorientation",o())));break;case"location":s.locationServicesEnabled&&(f++,1===f&&(d=navigator.geolocation.watchPosition(n(),n(),a())))}e.addEventListener.call(this,t,i)},removeEventListener:function(t,i){switch(t){case"heading":p&&(g--,0===g&&u());break;case"location":s.locationServicesEnabled&&(f--,1>g&&navigator.geolocation.clearWatch(d))}e.removeEventListener.call(this,t,i)},constants:{ACCURACY_HIGH:1,ACCURACY_LOW:2,ERROR_DENIED:1,ERROR_LOCATION_UNKNOWN:2,ERROR_TIMEOUT:3,locationServicesEnabled:{get:function(){return!!navigator.geolocation}},MobileWeb:{locationTimeout:1/0,maximumLocationAge:0,maximumHeadingAge:1e3,forwardGeocoderTimeout:void 0,reverseGeocoderTimeout:void 0},hasCompass:function(){return p}},properties:{accuracy:2}})});