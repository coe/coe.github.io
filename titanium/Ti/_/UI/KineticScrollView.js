define(["Ti/_/browser","Ti/_/declare","Ti/UI/View","Ti/_/lang","Ti/_/dom","Ti/_/style","Ti/UI","Ti/_/event"],function(e,t,i,r,n,o,a,s){var l=(o.set,n.unitize),u=n.calculateDistance,d=require.on,c=100,h=100;return t("Ti._.UI.KineticScrollView",i,{_initKineticScrollView:function(e,t,i,r){function n(){v=Date.now(),T=v-_,_=v,U++?(b=(b*(U-1)+U*(h-m)/T)/2/U,I=(I*(U-1)+U*(f-w)/T)/2/U):(b=(h-l)/T,I=(f-c)/T)}function o(){g=y._minTranslationX=Math.min(0,y._measuredWidth-y._borderLeftWidth-y._borderRightWidth-y._contentContainer._measuredWidth),p=y._minTranslationY=Math.min(0,y._measuredHeight-y._borderTopWidth-y._borderBottomWidth-y._contentContainer._measuredHeight)}var s,l,c,h,f,g,p,_,v,T,m,w,U,b,I,E,y=this;y._currentTranslationX=0,y._currentTranslationY=0,y._horizontalElastic="horizontal"===t||"both"===t,y._verticalElastic="vertical"===t||"both"===t,y._kineticTransform=a.create2DMatrix(),("horizontal"===i||"both"===i)&&y._createHorizontalScrollBar(),("vertical"===i||"both"===i)&&y._createVerticalScrollBar(),y._add(y._contentContainer=e),s=e.domNode,d(y._contentContainer,"postlayout",function(){o(),y._setTranslation(y._currentTranslationX,y._currentTranslationY)}),d(y,"draggingstart",function(t){if(y.scrollingEnabled){y._cancelAnimations(),b=void 0,I=void 0,l=y._currentTranslationX,c=y._currentTranslationY,U=0,_=(new Date).getTime(),o();var i=y._measuredWidth,r=y._measuredHeight,n=e._measuredWidth,a=e._measuredHeight;y._startScrollBars({x:-y._currentTranslationX/(n-i),y:-y._currentTranslationY/(a-r)},{x:i/n,y:r/a}),y._handleDragStart&&y._handleDragStart(t)}}),d(y,"dragging",function(e){y.scrollingEnabled&&(h=l+e.distanceX,f=c+e.distanceY,n(),y._setTranslation(m=h,w=f),y._handleDrag&&y._handleDrag(e))}),d(y,"draggingcancel",function(e){y.scrollingEnabled&&(y._animateToPosition(l,c,400+.3*u(l,c,y._currentTranslationX,y._currentTranslationY),a.ANIMATION_CURVE_EASE_IN_OUT,function(){y._handleDragCancel&&y._handleDragCancel(e)}),y._endScrollBars(),y._handleDragCancel&&y._handleDragCancel(e))}),d(y,"draggingend",function(e){if(y.scrollingEnabled){h=l+e.distanceX,f=c+e.distanceY,n();var t,i=y._currentTranslationX,r=y._currentTranslationY;i>0?(i=0,t=1):g>i&&(i=g,t=1),r>0?(r=0,t=1):p>r&&(r=p,t=1),t?y._animateToPosition(i,r,200,a.ANIMATION_CURVE_EASE_OUT,function(){y._handleDragEnd&&y._handleDragEnd(e),y._endScrollBars()}):y._handleDragEnd&&y._handleDragEnd(e,b,I)}});var C=-1!=navigator.userAgent.indexOf("Firefox")?"DOMMouseScroll":"mousewheel";r&&(this._disconnectMouseWheelEvent=d(y.domNode,C,function(t){if(y.scrollingEnabled){if("DOMMouseScroll"==C?(t.wheelDeltaY=40*-t.detail,t.wheelDeltaX=0):t.wheelDelta&&!t.wheelDeltaX&&(t.wheelDeltaY=t.wheelDelta,t.wheelDeltaX=0),t.shiftKey)t.wheelDeltaX=t.wheelDeltaY,t.wheelDeltaY=0;else if(t.ctrlKey)return t.preventDefault(),!1;y._cancelAnimations();var i=e._measuredWidth-y._measuredWidth,r=e._measuredHeight-y._measuredHeight,n=-y._currentTranslationX,a=-y._currentTranslationY;o(),y._startScrollBars({x:n/i,y:a/r},{x:y._measuredWidth/e._measuredWidth,y:y._measuredHeight/e._measuredHeight}),y._setTranslation(Math.min(0,Math.max(y._minTranslationX,-n+t.wheelDeltaX)),Math.min(0,Math.max(y._minTranslationY,-a+t.wheelDeltaY))),clearTimeout(E),E=setTimeout(function(){y._endScrollBars()},500),y._handleMouseWheel&&y._handleMouseWheel()}}))},destroy:function(){this._disconnectMouseWheelEvent&&this._disconnectMouseWheelEvent(),i.prototype.destroy.apply(this,arguments)},_animateToPosition:function(e,t,i,r,n){var o,a=this,s=a._contentContainer,l=(s.domNode,a._horizontalScrollBar),d=a._verticalScrollBar;u(a._currentTranslationX,a._currentTranslationY,e,t)<1?(a._setTranslation(e,t),n()):(o=a._setTranslation(e,t,1),a._contentAnimation=s.animate({transform:a._kineticTransform.translate(o.translationX,o.translationY),duration:Math.round(i),curve:r},n),a._horizontalScrollBarAnimation=l&&l.animate({transform:this._kineticTransform.translate(Math.max(0,Math.min(1,-o.translationX/(s._measuredWidth-a._measuredWidth)))*(this._measuredWidth-this._scrollBarWidth),0),duration:i,curve:r}),a._verticalScrollBarAnimation=d&&d.animate({transform:this._kineticTransform.translate(0,Math.max(0,Math.min(1,-o.translationY/(s._measuredHeight-a._measuredHeight)))*(this._measuredHeight-this._scrollBarHeight)),duration:i,curve:r}))},_setTranslation:function(e,t,i){function r(e){return c*(-1/(e/h+1)+1)}var n=this._contentContainer,o=this._minTranslationX,a=this._minTranslationY,s=this._horizontalElastic&&!this.disableBounce&&this._measuredWidth<n._measuredWidth,l=this._verticalElastic&&!this.disableBounce&&this._measuredHeight<n._measuredHeight,u=this._measuredWidth,d=this._measuredHeight,f=n._measuredWidth,g=n._measuredHeight;if(e>0?e=s?r(e):0:o>e&&(e=s?o-r(o-e):o),t>0?t=l?r(t):0:a>t&&(t=l?a-r(a-t):a),i||this._contentContainer.animate({transform:this._kineticTransform.translate(this._currentTranslationX=e,this._currentTranslationY=t)}),this._isScrollBarActive){var p=this._horizontalScrollBar,_=this._verticalScrollBar;p&&p.animate({transform:this._kineticTransform.translate(Math.max(0,Math.min(1,-e/(f-u)))*(this._measuredWidth-this._scrollBarWidth),0)}),_&&_.animate({transform:this._kineticTransform.translate(0,Math.max(0,Math.min(1,-t/(g-d)))*(this._measuredHeight-this._scrollBarHeight))})}return{translationX:e,translationY:t}},_cancelAnimations:function(){this._horizontalScrollBarAnimation&&this._horizontalScrollBarAnimation.cancel(),this._verticalScrollBarAnimation&&this._verticalScrollBarAnimation.cancel(),this._contentAnimation&&this._contentAnimation.cancel()},_createHorizontalScrollBar:function(){this._horizontalScrollBar||this._add(this._horizontalScrollBar=a.createView({zIndex:2147483647,backgroundColor:"#555",borderRadius:3,width:0,height:6,left:0,bottom:0,opacity:0}))},_createVerticalScrollBar:function(){this._verticalScrollBar||this._add(this._verticalScrollBar=a.createView({zIndex:2147483647,backgroundColor:"#555",borderRadius:3,width:6,height:0,right:0,top:0,opacity:0}))},_destroyHorizontalScrollBar:function(){this._horizontalScrollBarAnimation&&this._horizontalScrollBarAnimation.cancel(),this._remove(this._horizontalScrollBar)},_destroyVerticalScrollBar:function(){this._verticalScrollBarAnimation&&this._verticalScrollBarAnimation.cancel(),this._remove(this._verticalScrollBar)},_startScrollBars:function(e,t){if(this._horizontalScrollBar&&t.x<1&&t.x>0){var i=this._measuredWidth,r=this._scrollBarWidth=Math.round(Math.max(10,i*t.x)),n=this._horizontalScrollBar;n.opacity=.5,n.domNode.style.width=l(r),n.animate({transform:this._kineticTransform.translate(Math.max(0,Math.min(1,e.x))*(i-r),0)}),this._isScrollBarActive=1}if(this._verticalScrollBar&&t.y<1&&t.y>0){var o=this._measuredHeight,a=this._scrollBarHeight=Math.round(Math.max(10,o*t.y)),s=this._verticalScrollBar;s.opacity=.5,s.domNode.style.height=l(a),s.animate({transform:this._kineticTransform.translate(0,Math.max(0,Math.min(1,e.y))*(o-a))}),this._isScrollBarActive=1}},_endScrollBars:function(){function e(e){e&&e.animate({opacity:0,duration:500},function(){t._isScrollBarActive=!1})}if(this._isScrollBarActive){var t=this,i=t._horizontalScrollBar,r=t._verticalScrollBar;e(i),e(r)}},properties:{scrollingEnabled:!0}})});