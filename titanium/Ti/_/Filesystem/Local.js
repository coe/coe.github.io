define(["Ti/_","Ti/_/Evented","Ti/_/declare","Ti/_/encoding","Ti/_/lang","Ti/API","Ti/Blob"],function(e,t,i,r,n,o,a){function s(e,t){return m.getItem("ti:fs:"+(t?"meta:":"blob:")+e)}function l(e,t,i){return m.setItem("ti:fs:"+(i?"meta:":"blob:")+e,t),t.length}function u(e){var t=new XMLHttpRequest;return t.overrideMimeType&&t.overrideMimeType("text/plain; charset=x-user-defined"),t.open("GET","."+e,!1),t.send(null),200===t.status?{data:t.responseText,mimeType:t.getResponseHeader("Content-Type")}:null}function d(e){var t,i=[];return _||(_={"/":"tD\nr1"},require("./titanium/filesystem.registry").split(/\n|\|/).forEach(function(e,t){var r,n=0,e=e.split("	"),o=e.length;if(0===t&&"ts"===e[0])w=e[1],_[b]+="\nc"+w;else{for(;o>n&&!e[n];n++);i=i.slice(0,n).concat(r=e[n]),_[b+i.join(b)]="n"+r+"\nt"+(n+1==o?"D":"F\ns"+e[n+1])}})),(t=_[e])&&t+"\nr1\ne1\nc"+w+"\nm"+w}function c(){return T||(T=require("Ti/Filesystem"))}function h(e,t,i,r){var n,i=i||1,a=e+t.slice(0,i).join(b);return r&&r.readonly?(o.error('Unable to create "'+a+'" because parent is readonly'),!1):(n=new v({nativePath:a,type:"D"}),n.createDirectory(),++i>t.length?!0:h(e,t,i,n))}function p(e){if(e){var t=e.match(S),i=(t[1]?t[1]:t[2]+t[3])||b;return e=t[1]?t[2]:t[4],e?h(i,e.split(b)):!0}return!1}function f(e,t){var i,r,n=e.nativePath,o=new RegExp("^(ti:fs:meta|ti:fs:blob):"+n+(/\/$/.test(n)?"":b)+"(.*)"),a=0,s=m.length;if(t=c().getFile(t.nativePath,e.name),p(t.nativePath)){for(;s>a;)r=m.key(a++),(i=r.match(o))&&m.setItem(i[1]+":"+t.nativePath+b+i[2],m.getItem(r)||"");return!0}return!1}function g(){for(var e,t=/^ti:fs:tmp:\/\//,i=0,r=m.length;r>i;)e=m.key(i++),t.test(e)&&m.removeItem(e)}var _,v,T,w=Date.now(),U=require.is,m=localStorage,b="/",I={n:"sname",c:"i_created",m:"i_modified",t:"s_type",y:"s_mimeType",e:"b_remote",x:"bexecutable",r:"breadonly",s:"isize",l:"bsymbolicLink",h:"bhidden"},E={i:function(e){return e-0},s:function(e){return""+e},b:function(e){return!!(0|e)}},y="ti:fs:meta:",C="ti:fs:blob:",S=/(\/)?([^\:]*)(\:\/\/)?(.*)/,L="application/octet-stream,text/plain,text/html,text/css,text/xml,text/mathml,image/gif,image/jpeg,image/png,image/x-icon,image/svg+xml,application/x-javascript,application/json,application/pdf,application/x-opentype,audio/mpeg,video/mpeg,video/quicktime,video/x-flv,video/x-ms-wmv,video/x-msvideo,video/ogg,video/mp4,video/webm,text/csv".split(","),A={txt:1,html:2,htm:2,css:3,xml:4,mml:5,gif:6,jpeg:7,jpg:7,png:8,ico:9,svg:10,js:11,json:12,pdf:13,otf:14,mp3:15,mpeg:16,mpg:16,mov:17,flv:18,wmv:19,avi:20,ogg:21,ogv:21,mp4:22,m4v:22,webm:23,csv:24};return g(),require.on(window,"beforeunload",g),function(e,t){for(var i in e)s(i,1)||l(i,"c"+t+"\nm"+t+"\ntD\ne0\nx0\nl0\nh0\nr"+e[i],1)}({"appdata://":0,"/":1,"tmp://":0},Date.now()),v=i("Ti._.Filesystem.Local",t,{constructor:function(e){if(U(e,"String")){var t=e.match(S),i=!t[1]&&t[3];if(/^\.\./.test(e=i?t[4]:t[2]))throw new Error('Irrational path "'+e+'"');this.__values__.constants.nativePath=(i?t[2]+"://":b)+e}this._type=e&&"D"!==e._type?"F":"D"},postscript:function(e){var t,i,r=this.__values__.constants,n=this.nativePath,o=n&&s(n,1)||d(n),a=n.match(S),l=(a[1]?a[1]:a[2]+a[3])||b;o&&(this._exists=1)&&o.split("\n").forEach(function(e){var t=I[e.charAt(0)],i=t.substring(1),n=E[t.charAt(0)](e.substring(1));(r.hasOwnProperty(i)?r:this)[i]=n},this),n=a[1]?a[2]:a[4],t=n.split(b),r.name=t.pop(),t=t.join(b),i=r.parent=n?new v(l+t):null,i&&i.readonly||a&&a[1]&&(r.readonly=!0)},constants:{name:"",executable:!1,readonly:!1,size:0,symbolicLink:!1,nativePath:"",parent:null,writable:{get:function(){return!this.readonly},set:function(e){return this.__values__.constants.readonly=!e},value:!0}},properties:{hidden:!1},append:function(e){if(this.isFile()){switch(e&&e.declaredClass){case"Ti.Filesystem.File":e=e.read();case"Ti.Blob":this._mimeType=e.mimeType,e=e.text}var t=this.read();return t.append(e),this.write(t)}return!1},copy:function(e){if(this.exists&&e){var t=c(),e="Ti.Filesystem.File"===e.declaredClass?e:t.getFile.apply(null,arguments),i=e.parent,r=this.isFile();return e.exists()?e.readonly?!1:e.isFile()?r?e.write(this.read()):(Ti.API.error("Destination is not a directory"),!1):r?t.getFile(e.nativePath,this.name).write(this.read()):f(this,e):i&&(i.createDirectory(),!i.exists()||i.readonly||!r&&!e.createDirectory())?!1:r?e.write(this.read()):f(this,e)}return!1},createDirectory:function(){return this._create("D")},createFile:function(){return this._create("F")},createTimestamp:function(){return this._created||null},deleteDirectory:function(e){if(this.isDirectory()&&!this.readonly){for(var t=this.nativePath,i=new RegExp("^ti:fs:(meta|blob):"+t+(/\/$/.test(t)?"":b)+".*"),r=0,n=m.length;n>r;)if(i.test(key=m.key(r++))){if(!e)return Ti.API.error('Directory "'+t+'" not empty'),!1;m.removeItem(key)}return this._exists=0,m.removeItem(y+t),m.removeItem(C+t),!0}return!1},deleteFile:function(){if(this.exists()&&this.isFile()&&!this.readonly){var e=this.nativePath;return this._exists=0,m.removeItem(y+e),m.removeItem(C+e),!0}return!1},exists:function(){return!!this._exists},extension:function(){var e=this.name.match(/\.(.+)$/);return e?e[1]:""},getDirectoryListing:function(){function e(e,i){var r,n=e.match(i);n&&n[1]&&t.indexOf(r=n[1].split(b)[0])<0&&t.push(r)}var t=[];if(this.isDirectory()){for(var i=this.nativePath+(/\/$/.test(this.nativePath)?"":b),r=new RegExp("^"+y+i+"(.*)"),n=new RegExp("^"+i+"(.*)"),o=0,a=m.length;a>o;)e(m.key(o++),r);for(o in _)e(o,n)}return t.sort()},isDirectory:function(){return"D"===this._type},isFile:function(){return"F"===this._type},modificationTimestamp:function(){return this._modified||null},move:function(){return this.copy.apply(this,arguments)&&this[this.isFile()?"deleteFile":"deleteDirectory"](1)},open:function(e){var t=require("Ti/Filesystem/FileStream");return this.exists()&&this.isFile()?new t({mode:e,data:this.read().text}):null},read:function(){if(this.exists()&&this.isFile()){var t,i=this.nativePath,r=this._remote?(t=u(i)).data:s(i)||"",n=L[A[this.extension()]||0],o=t&&t.mimeType||this._mimeType||n,l=0,d=r.length,c="",h={file:this,data:r,length:d,mimeType:o="application/octet-stream"===o&&o!==n?n:o,nativePath:i};if(this._remote&&e.isBinaryMimeType(o)){for(;d>l;)c+=String.fromCharCode(255&r.charCodeAt(l++));h.data=btoa(c)}return new a(h)}return null},rename:function(e){if(this.exists&&!this.readonly){var t,i,r=this.nativePath,n=r,o=m.getItem(C+n),a=new RegExp("^ti:fs:(meta|blob):"+n+(/\/$/.test(n)?"":b)+"(.*)"),s=n.match(S),l=(s[1]?s[1]:s[2]+s[3])||b,u=0,d=m.length;this.__values__.constants;if(n=s[1]?s[2]:s[4],!n)return Ti.API.error("Can't rename root \""+l+'"'),!1;if(n=n.split(b),n.pop(),n.push(e),t=new v(n=l+n.join(b)),t.exists()||t.parent.readonly)return!1;if("D"===this._type)for(;d>u;)i=m.key(u++),(s=i.match(a))&&(m.setItem("ti:fs:"+s[1]+":"+n+b+s[2],m.getItem(i)),m.removeItem(i));return this._save(n,e),o&&m.setItem(C+n,o),m.removeItem(y+r),m.removeItem(C+r),!0}return!1},resolve:function(){return this.nativePath},spaceAvailable:function(){return"remainingSpace"in m?m.remainingSpace:null},write:function(e,t){var i=this.nativePath;if(i&&this.isFile()&&!this.readonly&&this.parent&&!this.parent.readonly){switch(e&&U(e,"String")&&(this._mimeType=L[1]),e&&e.declaredClass){case"Ti.Filesystem.File":e=e.read();case"Ti.Blob":this._mimeType=e.mimeType,e=e._data||""}return this._exists=1,this._modified=Date.now(),this._created||(this._created=this._modified),this.__values__.constants.size=l(i,t?this.read()+e:e),this._save()}return!1},_create:function(e){return!this.exists()&&this.parent&&!this.parent.readonly&&p(this.parent.nativePath)?(this._created=this._modified=Date.now(),this._exists=1,this._type=e,this._save()):!1},_save:function(e,t){var i,e=e||this.nativePath;return e?(i=["n",t||this.name,"\nc",this._created,"\nm",this._modified,"\nt",this._type,"\ne0\nx0\nr",0|this.readonly,"\nl",0|this.symbolicLink,"\nh",0|this.hidden],"F"===this._type&&i.push("\ns"+this.size),this._mimeType&&i.push("\ny"+this._mimeType),l(e,i.join(""),1),!0):!1}})});