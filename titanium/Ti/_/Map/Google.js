define(["Ti/_/declare","Ti/_/dom","Ti/_/event","Ti/App/Properties","Ti/Gesture","Ti/Geolocation","Ti/Map","Ti/UI/View","Ti/Utils"],function(e,t,i,r,n,o,a,s,l){function u(e){var t=d.MapTypeId;switch(e){case a.HYBRID_TYPE:return t.HYBRID;case a.SATELLITE_TYPE:return t.SATELLITE;case a.TERRAIN_TYPE:return t.TERRAIN}return t.ROADMAP}var d,c,h,f,p=require.on,g=s.prototype.fireEvent,_={latitude:39.828175,longitude:-98.5795,latitudeDelta:30.137412,longitudeDelta:63.235658},v={0:"red",1:"green",2:"purple"},T=Ti.deferStart(),w=e("Ti.Map.View",s,{constructor:function(){this.__values__.properties.annotations=[],this._annotationMap={},this._routes=[],this.fireEvent("loading")},postscript:function(){function e(e){var n=r.getCenter();setTimeout(function(){return c.trigger(r,"resize"),e?(t._updateMap(i,1),t._updateUserLocation(t.userLocation),t.annotations.forEach(t._createMarker,t),t._annotationEvents=[],void(t._boundsEvt=c.addListener(r,"bounds_changed",t._fitRegion.bind(t)))):void r.setCenter(n)},25)}var t=this,i=t.region||_,r=t._gmap=new d.Map(t.domNode,{disableDefaultUI:!0,zoom:2,zoomControl:!0,center:new d.LatLng(i.latitude,i.longitude),mapTypeId:u(t.mapType)});p.once(t,"postlayout",function(){e(1),n.addEventListener("orientationchange",function(){e()})})},destroy:function(){i.off(this._annotationEvents),c.removeListener(this._boundsEvt),c.clearInstanceListeners(this._gmap),this.removeAllAnnotations(),this._gmap=null,s.prototype.destroy.apply(this,arguments)},addAnnotation:function(e){e&&("Ti.Map.Annotation"===e.declaredClass||(e=new Annotation(e)),~this.annotations.indexOf(e)||this._createMarker(e),e.title&&(this._annotationMap[e.title]=e))},addAnnotations:function(e){e&&e.forEach(this.addAnnotation,this)},addRoute:function(e){e&&(e.points||[]).length&&(e.pline=new d.Polyline({map:this._gmap,path:e.points.map(function(e){return new d.LatLng(e.latitude,e.longitude)}),strokeColor:e.color||"#000",strokeWeight:e.width||1}),this._routes.push(e))},deselectAnnotation:function(e){require.is(e,"String")&&(e=this._annotationMap[e]),e&&h&&h.widgetId===e.widgetId&&this._hide(e)},removeAllAnnotations:function(){for(h&&h.close();this.annotations.length;)this.removeAnnotation(this.annotations[0])},removeAnnotation:function(e){if(require.is(e,"String")&&(e=this._annotationMap[e]),e){var t=this.__values__.properties.annotations,i=t.indexOf(e);h&&this._hide(e),c.removeListener(e.evt),e.marker.setMap(null),delete e.marker,e.destroy(),~i&&t.splice(i,1)}},removeAnnotations:function(e){e.forEach(function(e){this.removeAnnotation(e)},this)},removeRoute:function(e){if(e&&e.name)for(var t=this._routes,i=0;i<t.length;i++)t[i].name===e.name&&(e.pline.setMap(null),delete e.pline,t.splice(i--,1))},selectAnnotation:function(e){require.is(e,"String")&&(e=this._annotationMap[e]),e&&this._show(e)},setLocation:function(e){e&&(this.region=e),isDef(e.animate)&&(this.animated=e.animate),isDef(e.animated)&&(this.animated=e.animated),isDef(e.regionFit)&&(this.regionFit=e.regionFit),this._updateMap(e)},zoom:function(e){var t=this._gmap;t.setZoom(t.getZoom()+e)},_show:function(e,r){function n(){a||(a=1)&&s._dispatchEvents(e,r)}if(e&&(!h||h.widgetId!==e.widgetId)){var o,a,s=this,l=e.widgetId,u="TiMapAnnotation",f=t.create("div",{className:u}),g=f,_={annotation:g,leftButton:e.leftButton&&t.create("img",{className:u+"LeftButton",src:e.leftButton},f),rightButton:e.rightButton&&t.create("img",{className:u+"RightButton",src:e.rightButton},f),dummy:(f=t.create("div",{className:u+"Content"},f))&&0,title:t.create("h1",{innerHTML:e._getTitle()},f),subtitle:t.create("p",{innerHTML:e._getSubtitle()},f)};i.off(s._annotationEvents);for(o in _)!function(t,r){r&&s._annotationEvents.push(p(r,"click",function(r){i.stop(r),s._hide(e,t)}))}(o,_[o]);s._annotationEvents.push(p(e,"update",this,function(t){if(h.widgetId===l){var i,r=t.property,n=t.value,o=this._annotationMap;switch(r){case"title":case"subtitle":_[r].innerHTML=n,delete o[t.oldValue],n&&(o[n]=e);break;case"leftButton":case"rightButton":_[r].src=n;break;case"image":case"pincolor":i=s._getMarkerImage(e),e.marker.setIcon(i[0]),e.marker.setShadow(i[1]||null)}}})),h?(n(),h.setContent(g)):(h=new d.InfoWindow({content:g}),c.addListener(h,"domready",n),c.addListener(h,"closeclick",function(){s._hide(e,"annotation")})),h.open(s._gmap,e.marker),h.widgetId=e.widgetId}},_hide:function(e,t){t&&~t.indexOf("Button")||(h.close(),h.widgetId=0),this._dispatchEvents(e,t)},_dispatchEvents:function(e,t){var i=this.annotations.indexOf(e),r={annotation:e,clicksource:t=t||"pin",index:i,latitude:e.latitude,longitude:e.longitude,map:this,subtitle:e._getSubtitle(),title:e._getTitle()};g.call(this,"singletap",r),g.call(this,"click",r),e._onclick(this,i,t)},_getMarkerImage:function(e){var t,i,r=v[0|e.pincolor];return e.image&&("Ti.Blob"===e.image.declaredClass?(r=v[t=l.md5HexDigest(i=e.image.toString())],r||(r=v[t]=[new d.MarkerImage(i)])):(r=v[e.image],r||(r=v[e.image]=[new d.MarkerImage(e.image)]))),r},_createMarker:function(e){var t=this,i=t._getMarkerImage(e);e.evt=c.addListener(e.marker=new d.Marker({map:t._gmap,icon:i[0],shadow:i[1],position:new d.LatLng(e.latitude,e.longitude),optimized:!1,title:e._getTitle(),animation:e.animate&&d.Animation.DROP}),"click",function(){t[h&&h.widgetId===e.widgetId?"_hide":"_show"](e)}),t.__values__.properties.annotations.push(e)},_fitRegion:function(){var e=this.__values__.constants,t=this._gmap,i=t.getCenter(),r=t.getBounds(),n=r.getNorthEast(),o=r.getSouthWest(),a=e.latitudeDelta=n.lat()-o.lat(),s=e.longitudeDelta=n.lng()-o.lng(),l={latitude:i.lat(),longitude:i.lng(),latitudeDelta:a,longitudeDelta:s};this.regionFit&&(this.__values__.properties.region=l),this._initialized||(this._initialized=1,this.fireEvent("complete")),this.fireEvent("regionchanged",l)},_updateMap:function(e,t){var i=this._gmap;if(i){var r=!t&&this.animated,n=e.latitudeDelta/2,o=e.longitudeDelta/2;i[r?"panTo":"setCenter"](new d.LatLng(e.latitude,e.longitude)),i[r?"panToBounds":"fitBounds"](new d.LatLngBounds(new d.LatLng(e.latitude-n,e.longitude-o),new d.LatLng(e.latitude+n,e.longitude+o)))}},_updateUserLocation:function(e){var t=this,i=t._gmap;i&&(e||t._locationInited)&&(t._locationInited=1,o[e?"addEventListener":"removeEventListener"]("location",function(e){var i,r=t._locationMarker,n=e.coords,a=e.code;n?(i=new d.LatLng(n.latitude,n.longitude),r?r.setPosition(i):t._locationMarker=new d.Marker({map:t._gmap,icon:f,position:i})):"code"in e&&Ti.API.warn("Geolocation error: "+(a===o.ERROR_DENIED?"permission denied":a===o.ERROR_TIMEOUT?"timeout":a===o.ERROR_LOCATION_UNKNOWN?"position unavailable":"unknown"))}),o.locationServicesEnabled?(!e||t._locationMarker)&&t._locationMarker.setVisible(e):(Ti.API.warn("Geolocation services unavailable"),t.__values__.properties.userLocation=!1))},fireEvent:function(e,t){/(click|singletap)/.test(e)||s.prototype.fireEvent.apply(this,arguments)},constants:{latitudeDelta:0,longitudeDelta:0},properties:{animated:!1,annotations:{set:function(e){return e=e.filter(function(e){return e&&"Ti.Map.Annotation"===e.declaredClass}),this._gmap&&(this.removeAllAnnotations(),e.forEach(this._createMarker,this)),e}},mapType:{set:function(e){return this._gmap&&this._gmap.setMapTypeId(u(e)),e}},region:{set:function(e,t){return require.mix({},_,t,e)},post:function(e,t){e!==t&&this._updateMap(e)},value:null},regionFit:!0,userLocation:{post:function(e){this._updateUserLocation(e)},value:!1}}});return window.TiMapViewInit=function(){function e(e,t,n){return new d.MarkerImage(i+"marker_"+e+".png",new d.Size(t,34),new r(n,0),new r(10,34))}d=google.maps,c=d.event;var t,i="themes/"+require.config.ti.theme+"/Map/",r=d.Point;for(t in v)v[t]=[e(v[t],20,0),e(v[t],37,20)];f=new d.MarkerImage(i+"location.png",new d.Size(22,22),new r(0,0),new r(11,11)),T()},require(["//maps.googleapis.com/maps/api/js?key="+r.getString("ti.map.apikey","")+"&sensor=true&callback=TiMapViewInit"],0,T),w});