define(["Ti/_/declare","Ti/_/dom","Ti/_/event","Ti/_/lang","Ti/Media","Ti/UI/View"],function(e,t,i,r,o,n){function a(e){return U?!!s.mozFullScreen||!!s.webkitIsFullScreen:!!e}var s=document,l=require.on,u=require.config.vendorPrefixes.dom,d=0,c=1,h=2,p=3,f="requestFullScreen",g="exitFullScreen",U=function(){for(var e,t=0;t<u.length;t++)if(e=u[t].toLowerCase(),s[e+"CancelFullScreen"])return f=e+"RequestFullScreen",g=e+"ExitFullScreen",1;return!!s.cancelFullScreen}(),v=!0,w={m4v:"video/mp4",mov:"video/quicktime",mp4:"video/mp4",ogg:"video/ogg",ogv:"video/ogg",webm:"video/webm"};return e("Ti.Media.VideoPlayer",n,{_currentState:d,constructor:function(){this._handles=[]},properties:{autoplay:!1,currentPlaybackTime:{get:function(){return this._video?1e3*this._video.currentTime:0},set:function(e){return this._video&&(this._video.currentTime=e/1e3|0),e}},fullscreen:{value:a(),set:function(e){var t,i=this._video;if(e=!!e,U)try{e===a()&&(e=!e),i[e?f:g]()}catch(r){}else v&&(i.className=e?"fullscreen":"",e&&(t=l(window,"keydown",function(e){27===e.keyCode&&(this.fullscreen=0,t())})));return this.fireEvent("fullscreen",{entering:e}),e}},mediaControlStyle:{value:o.VIDEO_CONTROL_DEFAULT,set:function(e){return this._video&&(this._video.controls=e===o.VIDEO_CONTROL_DEFAULT),e}},repeatMode:o.VIDEO_REPEAT_MODE_NONE,scalingMode:{set:function(e){var t=this.domNode,i=o.VIDEO_SCALING_ASPECT_FIT,r={};return r[o.VIDEO_SCALING_NONE]="TiScalingNone",r[i]="TiScalingAspectFit",t.className=t.className.replace(/(scaling\-[\w\-]+)/,"")+" "+(r[e]||r[e=i]),e}},url:{set:function(e){return this.__values__.constants.playing=!1,this._currentState=d,this.__values__.properties.url=e,this._createVideo(),e}}},constants:{playbackState:o.VIDEO_PLAYBACK_STATE_STOPPED,playing:!1,initialPlaybackTime:0,endPlaybackTime:0,playableDuration:0,loadState:o.VIDEO_LOAD_STATE_UNKNOWN,duration:0},_set:function(e,t){var i={};i[e]=this.__values__.constants[e]=t,this.fireEvent(e.toLowerCase(),i)},_complete:function(e){var t="ended"===e.type;this.__values__.constants.playing=!1,this._currentState=d,this.fireEvent("complete",{reason:t?o.VIDEO_FINISH_REASON_PLAYBACK_ENDED:o.VIDEO_FINISH_REASON_USER_EXITED}),t&&this.repeatMode===o.VIDEO_REPEAT_MODE_ONE&&setTimeout(r.hitch(this,function(){this._video.play()}),1)},_stalled:function(){this._set("loadState",o.VIDEO_LOAD_STATE_STALLED)},_fullscreenChange:function(e){this.__values__.properties.fullscreen=!a(this.fullscreen)},_durationChange:function(){var e=1e3*this._video.duration,t=this.__values__.constants;e!==1/0&&(this.duration||this.fireEvent("durationavailable",{duration:e}),t.duration=t.playableDuration=t.endPlaybackTime=e)},_paused:function(){var e=o.VIDEO_PLAYBACK_STATE_STOPPED;this.__values__.constants.playing=!1,this._currentState===p?(this._currentState=h,e=o.VIDEO_PLAYBACK_STATE_PAUSED):this._currentState===c&&(this._video.currentTime=0),this._set("playbackState",e)},_createVideo:function(e){var i,r,n=this._video,a=this.url,s=this.__values__.constants;if(a){if(e&&n&&n.parentNode)return n;for(this.release(),n=this._video=t.create("video",{tabindex:0}),this.mediaControlStyle===o.VIDEO_CONTROL_DEFAULT&&(n.controls=1),this.scalingMode=o.VIDEO_SCALING_ASPECT_FIT,this._handles=[l(n,"playing",this,function(){this._currentState=p,s.playing=!0,this.fireEvent("playing",{url:n.currentSrc}),this._set("playbackState",o.VIDEO_PLAYBACK_STATE_PLAYING)}),l(n,"pause",this,"_paused"),l(n,"canplay",this,function(){this._set("loadState",o.VIDEO_LOAD_STATE_PLAYABLE),this._currentState===d&&this.autoplay&&n.play()}),l(n,"canplaythrough",this,function(){this._set("loadState",o.VIDEO_LOAD_STATE_PLAYTHROUGH_OK),this.fireEvent("preload")}),l(n,"loadeddata",this,function(){this.fireEvent("load")}),l(n,"loadedmetadata",this,"_durationChange"),l(n,"durationchange",this,"_durationChange"),l(n,"timeupdate",this,function(){s.currentPlaybackTime=1e3*this._video.currentTime,this._currentState===c&&this.pause()}),l(n,"error",this,function(){var e="Unknown error";switch(n.error.code){case 1:e="Aborted";break;case 2:e="Decode error";break;case 3:e="Network error";break;case 4:e="Unsupported format"}s.playing=!1,this._set("loadState",o.VIDEO_LOAD_STATE_UNKNOWN),this.fireEvent("error",{message:e}),this.fireEvent("complete",{reason:o.VIDEO_FINISH_REASON_PLAYBACK_ERROR})}),l(n,"abort",this,"_complete"),l(n,"ended",this,"_complete"),l(n,"stalled",this,"_stalled"),l(n,"waiting",this,"_stalled"),l(n,"mozfullscreenchange",this,"_fullscreenChange"),l(n,"webkitfullscreenchange",this,"_fullscreenChange")],this.domNode.appendChild(n),require.is(a,"Array")||(a=[a]),i=0;i<a.length;i++)r=a[i].match(/.+\.([^\/\.]+?)$/),t.create("source",{src:a[i],type:r&&w[r[1]]},n);return n}},play:function(){this._currentState!==p&&this._createVideo(1).play()},pause:function(){this._currentState===p&&this._createVideo(1).pause()},destroy:function(){this.release(),n.prototype.destroy.apply(this,arguments)},release:function(){var e=this._video,t=e&&e.parentNode;this._currentState=d,this.__values__.constants.playing=!1,t&&(i.off(this._handles),t.removeChild(e)),this._video=null},stop:function(){var e=this._video;this._currentState=c,e&&(e.pause(),e.currentTime=0)}})});