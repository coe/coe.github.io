define(["Ti/_/browser","Ti/_/declare","Ti/UI/View","Ti/_/lang","Ti/_/dom","Ti/_/style","Ti/UI","Ti/_/event"],function(e,a,t,i,n,s,o){var r=(s.set,n.unitize),_=n.calculateDistance,l=require.on,d=100,c=100;return a("Ti._.UI.KineticScrollView",t,{_initKineticScrollView:function(e,a,t,i){function n(){b=Date.now(),h=b-k,k=b,v++?(w=(w*(v-1)+v*(u-y)/h)/2/v,z=(z*(v-1)+v*(p-f)/h)/2/v):(w=(u-d)/h,z=(p-c)/h)}function s(){m=j._minTranslationX=Math.min(0,j._measuredWidth-j._borderLeftWidth-j._borderRightWidth-j._contentContainer._measuredWidth),g=j._minTranslationY=Math.min(0,j._measuredHeight-j._borderTopWidth-j._borderBottomWidth-j._contentContainer._measuredHeight)}var r,d,c,u,p,m,g,k,b,h,y,f,v,w,z,S,j=this;j._currentTranslationX=0,j._currentTranslationY=0,j._horizontalElastic="horizontal"===a||"both"===a,j._verticalElastic="vertical"===a||"both"===a,j._kineticTransform=o.create2DMatrix(),("horizontal"===t||"both"===t)&&j._createHorizontalScrollBar(),("vertical"===t||"both"===t)&&j._createVerticalScrollBar(),j._add(j._contentContainer=e),r=e.domNode,l(j._contentContainer,"postlayout",function(){s(),j._setTranslation(j._currentTranslationX,j._currentTranslationY)}),l(j,"draggingstart",function(a){if(j.scrollingEnabled){j._cancelAnimations(),w=void 0,z=void 0,d=j._currentTranslationX,c=j._currentTranslationY,v=0,k=(new Date).getTime(),s();var t=j._measuredWidth,i=j._measuredHeight,n=e._measuredWidth,o=e._measuredHeight;j._startScrollBars({x:-j._currentTranslationX/(n-t),y:-j._currentTranslationY/(o-i)},{x:t/n,y:i/o}),j._handleDragStart&&j._handleDragStart(a)}}),l(j,"dragging",function(e){j.scrollingEnabled&&(u=d+e.distanceX,p=c+e.distanceY,n(),j._setTranslation(y=u,f=p),j._handleDrag&&j._handleDrag(e))}),l(j,"draggingcancel",function(e){j.scrollingEnabled&&(j._animateToPosition(d,c,400+.3*_(d,c,j._currentTranslationX,j._currentTranslationY),o.ANIMATION_CURVE_EASE_IN_OUT,function(){j._handleDragCancel&&j._handleDragCancel(e)}),j._endScrollBars(),j._handleDragCancel&&j._handleDragCancel(e))}),l(j,"draggingend",function(e){if(j.scrollingEnabled){u=d+e.distanceX,p=c+e.distanceY,n();var a,t=j._currentTranslationX,i=j._currentTranslationY;t>0?(t=0,a=1):m>t&&(t=m,a=1),i>0?(i=0,a=1):g>i&&(i=g,a=1),a?j._animateToPosition(t,i,200,o.ANIMATION_CURVE_EASE_OUT,function(){j._handleDragEnd&&j._handleDragEnd(e),j._endScrollBars()}):j._handleDragEnd&&j._handleDragEnd(e,w,z)}}),i&&(this._disconnectMouseWheelEvent=l(j.domNode,"mousewheel",function(a){if(j.scrollingEnabled){j._cancelAnimations();var t=e._measuredWidth-j._measuredWidth,i=e._measuredHeight-j._measuredHeight,n=-j._currentTranslationX,o=-j._currentTranslationY;s(),j._startScrollBars({x:n/t,y:o/i},{x:j._measuredWidth/e._measuredWidth,y:j._measuredHeight/e._measuredHeight}),j._setTranslation(Math.min(0,Math.max(j._minTranslationX,-n+a.wheelDeltaX)),Math.min(0,Math.max(j._minTranslationY,-o+a.wheelDeltaY))),clearTimeout(S),S=setTimeout(function(){j._endScrollBars()},500),j._handleMouseWheel&&j._handleMouseWheel()}}))},destroy:function(){this._disconnectMouseWheelEvent&&this._disconnectMouseWheelEvent(),t.prototype.destroy.apply(this,arguments)},_animateToPosition:function(e,a,t,i,n){var s,o=this,r=o._contentContainer,l=(r.domNode,o._horizontalScrollBar),d=o._verticalScrollBar;1>_(o._currentTranslationX,o._currentTranslationY,e,a)?(o._setTranslation(e,a),n()):(s=o._setTranslation(e,a,1),o._contentAnimation=r.animate({transform:o._kineticTransform.translate(s.translationX,s.translationY),duration:Math.round(t),curve:i},n),o._horizontalScrollBarAnimation=l&&l.animate({transform:this._kineticTransform.translate(Math.max(0,Math.min(1,-s.translationX/(r._measuredWidth-o._measuredWidth)))*(this._measuredWidth-this._scrollBarWidth),0),duration:t,curve:i}),o._verticalScrollBarAnimation=d&&d.animate({transform:this._kineticTransform.translate(0,Math.max(0,Math.min(1,-s.translationY/(r._measuredHeight-o._measuredHeight)))*(this._measuredHeight-this._scrollBarHeight)),duration:t,curve:i}))},_setTranslation:function(e,a,t){function i(e){return d*(-1/(e/c+1)+1)}var n=this._contentContainer,s=this._minTranslationX,o=this._minTranslationY,r=this._horizontalElastic&&!this.disableBounce&&this._measuredWidth<n._measuredWidth,_=this._verticalElastic&&!this.disableBounce&&this._measuredHeight<n._measuredHeight,l=this._measuredWidth,u=this._measuredHeight,p=n._measuredWidth,m=n._measuredHeight;if(e>0?e=r?i(e):0:s>e&&(e=r?s-i(s-e):s),a>0?a=_?i(a):0:o>a&&(a=_?o-i(o-a):o),t||this._contentContainer.animate({transform:this._kineticTransform.translate(this._currentTranslationX=e,this._currentTranslationY=a)}),this._isScrollBarActive){var g=this._horizontalScrollBar,k=this._verticalScrollBar;g&&g.animate({transform:this._kineticTransform.translate(Math.max(0,Math.min(1,-e/(p-l)))*(this._measuredWidth-this._scrollBarWidth),0)}),k&&k.animate({transform:this._kineticTransform.translate(0,Math.max(0,Math.min(1,-a/(m-u)))*(this._measuredHeight-this._scrollBarHeight))})}return{translationX:e,translationY:a}},_cancelAnimations:function(){this._horizontalScrollBarAnimation&&this._horizontalScrollBarAnimation.cancel(),this._verticalScrollBarAnimation&&this._verticalScrollBarAnimation.cancel(),this._contentAnimation&&this._contentAnimation.cancel()},_createHorizontalScrollBar:function(){this._horizontalScrollBar||this._add(this._horizontalScrollBar=o.createView({zIndex:2147483647,backgroundColor:"#555",borderRadius:3,width:0,height:6,left:0,bottom:0,opacity:0}))},_createVerticalScrollBar:function(){this._verticalScrollBar||this._add(this._verticalScrollBar=o.createView({zIndex:2147483647,backgroundColor:"#555",borderRadius:3,width:6,height:0,right:0,top:0,opacity:0}))},_destroyHorizontalScrollBar:function(){this._horizontalScrollBarAnimation&&this._horizontalScrollBarAnimation.cancel(),this._remove(this._horizontalScrollBar)},_destroyVerticalScrollBar:function(){this._verticalScrollBarAnimation&&this._verticalScrollBarAnimation.cancel(),this._remove(this._verticalScrollBar)},_startScrollBars:function(e,a){if(this._horizontalScrollBar&&1>a.x&&a.x>0){var t=this._measuredWidth,i=this._scrollBarWidth=Math.round(Math.max(10,t*a.x)),n=this._horizontalScrollBar;n.opacity=.5,n.domNode.style.width=r(i),n.animate({transform:this._kineticTransform.translate(Math.max(0,Math.min(1,e.x))*(t-i),0)}),this._isScrollBarActive=1}if(this._verticalScrollBar&&1>a.y&&a.y>0){var s=this._measuredHeight,o=this._scrollBarHeight=Math.round(Math.max(10,s*a.y)),_=this._verticalScrollBar;_.opacity=.5,_.domNode.style.height=r(o),_.animate({transform:this._kineticTransform.translate(0,Math.max(0,Math.min(1,e.y))*(s-o))}),this._isScrollBarActive=1}},_endScrollBars:function(){function e(e){e&&e.animate({opacity:0,duration:500},function(){a._isScrollBarActive=!1})}if(this._isScrollBarActive){var a=this,t=a._horizontalScrollBar,i=a._verticalScrollBar;e(t),e(i)}},properties:{scrollingEnabled:!0}})});