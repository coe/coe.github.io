define(["./declare","./lang"],function(e,a){var t=require.is,i=e("Ti._.Promise",null,{constructor:function(e){this._canceller=e},resolve:function(e){this._complete(e,0)},reject:function(e){this._complete(e,1)},then:function(e,a){var t={resolved:e,error:a,promise:new i(this.cancel)};return this._nextListener?this._head=this._head.next=t:this._nextListener=this._head=t,this._finished&&this._notify(this._fired),t.returnPromise},cancel:function(){if(!this._finished){var e=this._canceller&&this._canceller(this);this._finished||(e instanceof Error||(e=Error(e)),e.log=!1,this.reject(e))}},_fired:-1,_complete:function(e,a){if(this._fired=a,this._finished)throw Error("This promise has already been resolved");this._result=e,this._finished=!0,this._notify(a)},_notify:function(e){for(var i,n,s;this._nextListener;)if(n=this._nextListener,this._nextListener=this._nextListener.next,i=n[e?"error":"resolved"])try{s=i(this._result),s&&t(s.then,"Function")?s.then(a.hitch(n.promise,"resolve"),a.hitch(n.promise,"reject")):n.promise.resolve(s)}catch(o){n.promise.reject(o)}else n.promise[e?"reject":"resolve"](result)}});return i.when=function(e,a,i,n){return e&&t(e.then,"function")?e.then(a,i,n):a?a(e):e},i});