define(["Ti/_/declare","Ti/_/UI/Widget","Ti/_/dom","Ti/_/event","Ti/_/lang","Ti/_/text!Ti/_/UI/WebViewBridge.js","Ti/App","Ti/API","Ti/UI","Ti/_/style"],function(e,a,t,i,n,s,o,r,_,l){var d=require.on;return e("Ti.UI.WebView",a,{constructor:function(){o.addEventListener(this.widgetId+":unload",n.hitch(this,function(){this._loading(1)})),this.backgroundColor="#fff",l.set(this.domNode,{overflow:"auto",overflowScrolling:"touch"})},destroy:function(){o.removeEventListener(this.widgetId+":unload"),this._destroy(),a.prototype.destroy.apply(this,arguments)},_destroy:function(){this._iframe&&(i.off(this._iframeHandles),t.destroy(this._iframe))},_createIFrame:function(){if(this._parent){this._destroy(),this._loading(1);var e=this.url||"",a=e.match(/(https?)\:\/\/([^\:\/]*)(:?\d*)(.*)/),i=window.location,n=!a||a[0]+":"===i.protocol&&a[1]+a[2]===window.location.host,o=this._iframe=t.create("iframe",{frameborder:0,marginwidth:0,marginheight:0,hspace:0,vspace:0,scrolling:this.showScrollbars?"auto":"no",src:e||require.toUrl("Ti/_/UI/blank.html"),style:{width:"100%",height:"100%",position:"absolute"}},this.domNode);return this._iframeHandles=[d(o,"load",this,function(){var e,a,t,i=Math.max(0|n,0),_=o.contentWindow;if(-1!==i)n=-1;else for(e in _){i++;break}i>0?(a=_.location.href,this.evalJS(s.replace("WEBVIEW_ID",this.widgetId+":unload")),(t=this.properties.__values__.html)&&this._setContent(t)):r.warn("Unable to inject WebView bridge into cross-domain URL, ignore browser security message"),this._loading(),this.fireEvent("load",{url:a?this.properties.__values__.url=a:this.url})}),d(o,"error",this,function(){this._loading(),this.fireEvent("error",{message:"Page failed to load",url:this.url})})],1}},_setParent:function(){a.prototype._setParent.apply(this,arguments),(this.url||this.html)&&this._createIFrame()},_getWindow:function(){return this._iframe.contentWindow},_getDoc:function(){return this._getWindow().document},_getHistory:function(){return this._getWindow().history},_loading:function(e){this.loading||e&&this.fireEvent("beforeload",{url:this.url}),this.constants.loading=!!e},canGoBack:function(){return this.url&&!!this._getHistory().length},canGoForward:function(){return this.url&&!!this._getHistory().length},evalJS:function(e){var a=this._getWindow(),t=null;try{t=e&&a&&a.eval&&a.eval(e)}catch(i){}return t},goBack:function(){if(this.canGoBack()){var e=this._getHistory();e&&(this._loading(1),e.go(-1))}},goForward:function(){if(this.canGoForward()){var e=this._getHistory();e&&(this._loading(1),e.go(1))}},reload:function(){var e=this._getWindow();this.url&&e?e.location.href=this.url:this._createIFrame()},stopLoading:function(e){try{this.loading&&e?this._destroy():this._getWindow().stop()}catch(a){}this._loading()},_defaultWidth:_.FILL,_defaultHeight:_.FILL,_getContentSize:function(){return{width:this._iframe?this._iframe.clientWidth:0,height:this._iframe?this._iframe.clientHeight:0}},_setContent:function(e){try{var a=this._getDoc();a.open(),a.write(e),a.close()}catch(t){}return e},properties:{data:{set:function(e){var a=e;switch(a&&a.declaredClass){case"Ti.Filesystem.File":a=a.read();case"Ti.Blob":a=""+a;default:this.html=a}return e}},html:{get:function(e){var a=this._iframe&&this._getDoc();return void 0===e&&a?a.documentElement.innerHTML:e},post:function(e){var a=this.properties.__values__;a.data=void 0,a.url=void 0,this._createIFrame()&&this._setContent(e)}},showScrollbars:{set:function(e){return this._iframe&&t.attr.set(this._iframe,"scrolling",e?"auto":"no"),e},value:!0},url:{post:function(){var e=this.properties.__values__;e.data=void 0,e.html=void 0,this._createIFrame()}}},constants:{loading:!1}})});