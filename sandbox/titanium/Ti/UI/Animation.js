define(["Ti/_/declare","Ti/_/Evented","Ti/_/style","Ti/UI"],function(e,a,t,i){function n(){i._layoutInProgress?u.once(i,"postlayout",function(){requestAnimationFrame(s)}):requestAnimationFrame(s)}function s(){var e,a,t,i,s,o,r,d,u,p,m,g,k,y=c();_=0;for(e in S)for(a=S[e],s=0;a.length>s;s++)if(t=a[s],!t.paused){if(p=t.duration?Math.min(1,(y-t.ts)/t.duration):1,m=l[t.curve](t.forward?p:1-p),i=t.elem,i._isAttachedToActiveWin())for(prop in t.props){if(k=t.props[prop],d=k[0],u=k[1],1===p&&(g=t.forward?u:d),"transform"===prop){if(1!==p){for(g=[],r=d.length,o=0;r>o;o++)(12>o||o>14)&&(g[o]=d[o]+(u[o]-d[o])*m);_=1}16===g.length?(o=g.splice(12),g="matrix3d("+g.join(",")+") rotate3d("+o.join(",")+"deg)"):(o=g.pop(),g="matrix("+g.join(",")+") rotate("+o+"deg)"),prop=j}else if(b[prop]){if(1!==p){for(g=[],o=0;4>o;o++)g[o]=Math.floor(d[o]+(u[o]-d[o])*m);_=1}g="rgba("+g.join(",")+")"}else h[prop]&&(1!==p&&(g=d+(u-d)*m,_=1),g="opacity"===prop?g:g+"px");t.prev!==g&&(i.domNode.style[prop]=g),t.prev=g}1===p&&(t.ts=y,t.duration&&t.reverse&&t.forward?(t.forward=0,_=1):t.repeat-->0?_=t.forward=1:(a.splice(s--,1),t.promise.resolve(),a.length||delete S[e]))}_&&n()}function o(e){var a,t,i,n;if(e=e.trim().toLowerCase(),"#"===e.charAt(0))t=4==e.length?4:8,isNaN(e=Number("0x"+e.substring(1)))||(i=(1<<t)-1,n=4===t?17:1,n=[(e>>2*t&i)*n,(e>>t&i)*n,(e&i)*n,1]);else if(a=e.match(y))for(n=a[1].split(/\s*,\s*/),a=0;3>a;)n[a++]|=0;else P&&(n=P[e]);return n?(n[3]=isNaN(a=parseFloat(n[3]))?1:Math.min(Math.max(a,0),1),n):void 0}function r(e,a,t,i){var n,s,o,r,_=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];if(e)if(n=e[1],s=e[2].split(","),o=s.length,n&&16===o)for(r=0;12>r;r++)_[r]=s[r];else n||6!==o||(_[0]=s[0],_[1]=s[1],_[4]=s[2],_[5]=s[3],_[3]=s[4],_[7]=s[5]);if(a)if(n=a[1],s=a[2].split(","),o=s.length,n&&4===o)for(r=0;4>r;r++)_[12+r]=s[r];else n||1!==o||(_[14]=1,_[15]=s[0]);return t=2===i?[t.a,t.b,0,t.tx,t.c,t.d,0,t.ty,0,0,1,0,0,0,1,t.rotation]:[t.m11,t.m12,t.m13,t.m14,t.m21,t.m22,t.m23,t.m24,t.m31,t.m32,t.m33,t.m34,t.rotationX,t.rotationY,t.rotationZ,t.rotation],[_,t]}for(var _,l=[function(e){return e*=2,1>e?Math.pow(e,2)/2:-1*(--e*(e-2)-1)/2},function(e){return Math.pow(e,2)},function(e){return-1*e*(e-2)},function(e){return e}],d=window,c=Date.now,u=require.on,p=0,m=["ms","moz","webkit","o"],g=m.length,k={autoreverse:1,bottom:1,center:1,curve:1,delay:1,duration:1,repeat:1,right:1,visible:1,zIndex:1},b={backgroundColor:1,color:1},h={height:1,left:1,opacity:1,top:1,width:1},y=/^rgba?\(([\s\.,0-9]+)\)/,f=/3d/,v=/^Ti\.UI\.(2|3)DMatrix$/,w=/matrix(3d)?\(([^\)]*)/,z=/rotate(3d)?\(([^\)]*)/,S={},j=t.discover("transform"),P=require(require.config.ti.colorsModule),A=e("Ti.UI.Animation",a,{properties:{autoreverse:void 0,backgroundColor:void 0,bottom:void 0,center:void 0,color:void 0,curve:void 0,delay:void 0,duration:void 0,height:void 0,left:void 0,opacity:void 0,repeat:void 0,right:void 0,top:void 0,transform:void 0,visible:void 0,width:void 0,zIndex:void 0}});--g>=0&&!d.requestAnimationFrame;)d.requestAnimationFrame=d[m[g]+"RequestAnimationFrame"];return d.requestAnimationFrame||(d.requestAnimationFrame=function(e){var a=c(),t=Math.max(0,16-(a-p)),i=window.setTimeout(function(){e(a+t)},t);return p=a+t,i}),A._play=function(e,a){function i(){var i,s,y,j,P,A,I,T,x,M,D={},N=e._parent._layout.calculateAnimation(e,a);for(y in g)if(A=g[y],!k[y]&&void 0!==A){for(i=0;m.length>i;i++)delete m[i].props[y],require.isEmpty(m[i].props)&&m.splice(i--,1);if(j=t.get(e.domNode,y),b[y])j=o(j),A=o(A),(A>j||j>A)&&(D[y]=[j,A]);else if(h[y])isNaN(j=parseFloat(j))&&"opacity"===y&&(j=1),A=y in N?N[y]:A,j!==A&&(D[y]=[j,A]);else if("transform"===y&&(P=A.declaredClass.match(v))){if(P=0|P[1],x=j.match(w),M=j.match(z),f.test(j)||3===P)I=r(x,M,A,P),j=I[0],A=I[1];else if(2===P){if(j=[1,0,0,1,0,0,0],x)for(T=x[2].split(","),s=Math.min(6,T.length),i=0;s>i;i++)j[i]=parseFloat(T[i]);M&&(T=M[2].split(","),T.length&&(j[6]=parseFloat(T[0]))),A=[A.a,A.b,A.c,A.d,A.tx,A.ty,A.rotation],I=[j,A]}(A>j||j>A)&&(D[y]=I)}}S[u].push({id:p,elem:e,promise:d,props:D,ts:c(),reverse:!!g.autoreverse,forward:1,curve:Math.max(0,Math.min(l.length-1,0|g.curve)),duration:0|g.duration,repeat:!!g.repeat}),a.fireEvent("start"),_||(_=1,n())}function s(){for(var e=S[u],a=0,t=e&&e.length;t>a;a++)if(e[a].id===p)return e[a]}var d=new require.Promise,u=e.widgetId,p=0|1e9*Math.random(),m=S[u]=S[u]||[],g=a.properties.__values__,y=0|g.delay,j=!!g.visible;return y?setTimeout(i,y):i(),d.source=e,d.animation=a,d.pause=function(){var e=s();return e=!!e&&(e.paused||(e.paused=c())),a.fireEvent("pause"),e},d.resume=function(){var e=s();return e&&(e.paused&&(e.ts+=c()-e.paused),_||(_=1,n())),e=!!e&&!(e.paused=0),a.fireEvent("resume"),e},d.cancel=function(e){for(var i,n,s,o=S[u],r=0,_=o&&o.length,l=!1;_>r;r++)if(o[r].id===p){if(i=o[r],e){s=i.elem.domNode;for(n in i.props)_=i.props[n][0],t.set(s,n,h[n]&&"opacity"!==n?_+"px":_)}o.splice(r,1),o.length||delete S[u],l=!0;break}return a.fireEvent("cancel"),l},d.then(function(){void 0!==g.visible&&(e.visible=j),void 0!==g.zIndex&&(e.zIndex=zIndex),a.fireEvent("complete")})},A});