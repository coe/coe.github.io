var WindowManager=require("helper/WindowManager"),Utils=require("helper/Utils"),Cloud=require("ti.cloud");exports["Create Photo"]=function(e){var t=WindowManager.createWindow({backgroundColor:"white"}),i=Ti.UI.createScrollView({top:0,contentHeight:"auto",layout:"vertical"});if(t.add(i),Ti.UI.createProgressBar){var r=Ti.UI.createProgressBar({top:10+Utils.u,right:10+Utils.u,left:10+Utils.u,max:1,min:0,value:0,height:25+Utils.u});i.add(r),r.show()}var o;if(Ti.Media.openPhotoGallery){var n=Ti.UI.createButton({title:"Select Photo from Gallery",top:10+Utils.u,left:10+Utils.u,right:10+Utils.u,bottom:10+Utils.u,height:40+Utils.u});n.addEventListener("click",function(e){Ti.Media.openPhotoGallery({success:function(e){o=e.media}})}),i.add(n)}if(Ti.Media.showCamera){var a=Ti.UI.createButton({title:"Take Photo with Camera",top:10+Utils.u,left:10+Utils.u,right:10+Utils.u,bottom:10+Utils.u,height:40+Utils.u});a.addEventListener("click",function(e){Ti.Media.showCamera({success:function(e){o=e.media}})}),i.add(a)}var s,l=Ti.UI.createButton({title:"Choose Collection",top:10+Utils.u,left:10+Utils.u,right:10+Utils.u,bottom:10+Utils.u,height:40+Utils.u});l.addEventListener("click",function(e){function i(e){Cloud.PhotoCollections.search({user_id:e},function(e){if(e.success)if(0==e.collections.length)t.remove(r),alert("No photo collections exist! Create one first.");else{var i=[];i.push(Ti.UI.createTableViewRow({title:"No Collection",id:"",hasCheck:!s})),function o(e,t){for(var r=0,n=e.length;n>r;r++)i.push(Ti.UI.createTableViewRow({title:t+e[r].name,id:e[r].id,hasCheck:s==e[r].id})),e[r].subcollections&&o(e[r].subcollections,e[r].name+":")}(e.collections,""),r.setData(i)}else t.remove(r),Utils.error(e)})}var r=Ti.UI.createTableView({backgroundColor:"#fff",data:[{title:"Loading, please wait..."}]});r.addEventListener("click",function(e){s=e.row.id,t.remove(r)}),t.add(r),Cloud.Users.showMe(function(e){e.success?i(e.users[0].id):(r.setData([{title:e.error&&e.message||e}]),Utils.error(e))})}),i.add(l);var u=Ti.UI.createButton({title:"Create",top:10+Utils.u,left:10+Utils.u,right:10+Utils.u,bottom:10+Utils.u,height:40+Utils.u});return u.addEventListener("click",function(e){return o?(Ti.UI.createProgressBar&&(Cloud.onsendstream=function(e){r.value=.5*e.progress},Cloud.ondatastream=function(e){r.value=.5*e.progress+.5}),void Cloud.Photos.create({photo:o,collection_id:s,"photo_sync_sizes[]":"small_240"},function(e){Cloud.onsendstream=Cloud.ondatastream=null,e.success?(o=null,s=null,alert("Uploaded!")):Utils.error(e)})):void alert("Please provide a photo!")}),i.add(u),t};