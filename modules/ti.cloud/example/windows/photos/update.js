var WindowManager=require("helper/WindowManager"),Utils=require("helper/Utils"),Cloud=require("ti.cloud");exports["Update Photo"]=function(e){function t(){for(var t=0;t<h.length;t++){if(!h[t].value.length)return void h[t].focus();h[t].blur()}d.hide(),o&&Ti.UI.createProgressBar&&(Cloud.onsendstream=function(e){c.value=.5*e.progress},Cloud.ondatastream=function(e){c.value=.5*e.progress+.5}),Cloud.Photos.update({photo_id:e.id,photo:o,tags:u.value,collection_id:s},function(e){o&&(Cloud.onsendstream=Cloud.ondatastream=null),e.success?(o=null,alert("Updated!")):Utils.error(e),d.show()})}var i=WindowManager.createWindow({backgroundColor:"white"}),r=Ti.UI.createScrollView({top:0,contentHeight:"auto",layout:"vertical"});i.add(r);var o;if(Ti.Media.openPhotoGallery){var n=Ti.UI.createButton({title:"Select Photo from Gallery",top:10+Utils.u,left:10+Utils.u,right:10+Utils.u,bottom:10+Utils.u,height:40+Utils.u});n.addEventListener("click",function(e){Ti.Media.openPhotoGallery({success:function(e){o=e.media}})}),r.add(n)}if(Ti.Media.showCamera){var a=Ti.UI.createButton({title:"Take Photo with Camera",top:10+Utils.u,left:10+Utils.u,right:10+Utils.u,bottom:10+Utils.u,height:40+Utils.u});a.addEventListener("click",function(e){Ti.Media.showCamera({success:function(e){o=e.media}})}),r.add(a)}var s,l=Ti.UI.createButton({title:"Choose Collection",top:10+Utils.u,left:10+Utils.u,right:10+Utils.u,bottom:10+Utils.u,height:40+Utils.u});l.addEventListener("click",function(e){function t(e){Cloud.PhotoCollections.search({user_id:e},function(e){if(e.success)if(0==e.collections.length)i.remove(r),alert("No photo collections exist! Create one first.");else{var t=[];t.push(Ti.UI.createTableViewRow({title:"No Collection",id:"",hasCheck:!s})),function o(e,i){for(var r=0,n=e.length;n>r;r++)t.push(Ti.UI.createTableViewRow({title:i+e[r].name,id:e[r].id,hasCheck:s==e[r].id})),e[r].subcollections&&o(e[r].subcollections,e[r].name+":")}(e.collections,""),r.setData(t)}else i.remove(r),Utils.error(e)})}var r=Ti.UI.createTableView({backgroundColor:"#fff",data:[{title:"Loading, please wait..."}]});r.addEventListener("click",function(e){s=e.row.id,i.remove(r)}),i.add(r),Cloud.Users.showMe(function(e){e.success?t(e.users[0].id):(r.setData([{title:e.error&&e.message||e}]),Utils.error(e))})}),r.add(l);var u=Ti.UI.createTextField({hintText:"Tags (csv)",top:10+Utils.u,left:10+Utils.u,right:10+Utils.u,height:40+Utils.u,borderStyle:Ti.UI.INPUT_BORDERSTYLE_ROUNDED,autocapitalization:Ti.UI.TEXT_AUTOCAPITALIZATION_NONE,autocorrect:!1});r.add(u);var d=Ti.UI.createButton({title:"Update",top:10+Utils.u,left:10+Utils.u,right:10+Utils.u,bottom:10+Utils.u,height:40+Utils.u});if(r.add(d),Ti.UI.createProgressBar){var c=Ti.UI.createProgressBar({top:10+Utils.u,right:10+Utils.u,left:10+Utils.u,max:1,min:0,value:0,height:25+Utils.u});r.add(c),c.show()}var h=[u];d.addEventListener("click",t);for(var p=0;p<h.length;p++)h[p].addEventListener("return",t);var f=Ti.UI.createLabel({text:"Loading, please wait...",textAlign:"center",top:0,right:0,bottom:0,left:0,backgroundColor:"#fff",zIndex:2});return i.add(f),i.addEventListener("open",function(){Cloud.Photos.show({photo_id:e.id},function(e){if(f.hide(),e.success){var t=e.photos[0];t.collections&&t.collections.length>0&&(s=t.collections[0].id),u.value=t.tags&&t.tags.join(","),u.focus()}else Utils.error(e)})}),i};