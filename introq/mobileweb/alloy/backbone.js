(function(){var e,t=this,i=t.Backbone,n=Array.prototype.slice,r=Array.prototype.splice;e="undefined"!=typeof exports?exports:t.Backbone={},e.VERSION="0.9.2";var o=t._;o||"undefined"==typeof require||(o=require("alloy/underscore"));var a=t.jQuery||t.Zepto||t.ender;e.setDomLibrary=function(e){a=e},e.noConflict=function(){return t.Backbone=i,this},e.emulateHTTP=!1,e.emulateJSON=!1;var s=/\s+/,l=e.Events={on:function(e,t,i){var n,r,o,a,l;if(!t)return this;for(e=e.split(s),n=this._callbacks||(this._callbacks={});r=e.shift();)l=n[r],o=l?l.tail:{},o.next=a={},o.context=i,o.callback=t,n[r]={tail:a,next:l?l.next:o};return this},off:function(e,t,i){var n,r,a,l,u,c;if(r=this._callbacks){if(!(e||t||i))return delete this._callbacks,this;for(e=e?e.split(s):o.keys(r);n=e.shift();)if(a=r[n],delete r[n],a&&(t||i))for(l=a.tail;(a=a.next)!==l;)u=a.callback,c=a.context,(t&&u!==t||i&&c!==i)&&this.on(n,u,c);return this}},trigger:function(e){var t,i,r,o,a,l,u;if(!(r=this._callbacks))return this;for(l=r.all,e=e.split(s),u=n.call(arguments,1);t=e.shift();){if(i=r[t])for(o=i.tail;(i=i.next)!==o;)i.callback.apply(i.context||this,u);if(i=l)for(o=i.tail,a=[t].concat(u);(i=i.next)!==o;)i.callback.apply(i.context||this,a)}return this}};l.bind=l.on,l.unbind=l.off;var u=e.Model=function(e,t){var i;e||(e={}),t&&t.parse&&(e=this.parse(e)),(i=I(this,"defaults"))&&(e=o.extend({},i,e)),t&&t.collection&&(this.collection=t.collection),this.attributes={},this._escapedAttributes={},this.cid=o.uniqueId("c"),this.changed={},this._silent={},this._pending={},this.set(e,{silent:!0}),this.changed={},this._silent={},this._pending={},this._previousAttributes=o.clone(this.attributes),this.initialize.apply(this,arguments)};o.extend(u.prototype,l,{changed:null,_silent:null,_pending:null,idAttribute:"id",initialize:function(){},toJSON:function(){return o.clone(this.attributes)},get:function(e){return this.attributes[e]},escape:function(e){var t;if(t=this._escapedAttributes[e])return t;var i=this.get(e);return this._escapedAttributes[e]=o.escape(null==i?"":""+i)},has:function(e){return null!=this.get(e)},set:function(e,t,i){var n,r,a;if(o.isObject(e)||null==e?(n=e,i=t):(n={},n[e]=t),i||(i={}),!n)return this;if(n instanceof u&&(n=n.attributes),i.unset)for(r in n)n[r]=void 0;if(!this._validate(n,i))return!1;this.idAttribute in n&&(this.id=n[this.idAttribute]);var s=i.changes={},l=this.attributes,c=this._escapedAttributes,d=this._previousAttributes||{};for(r in n)a=n[r],(!o.isEqual(l[r],a)||i.unset&&o.has(l,r))&&(delete c[r],(i.silent?this._silent:s)[r]=!0),i.unset?delete l[r]:l[r]=a,o.isEqual(d[r],a)&&o.has(l,r)==o.has(d,r)?(delete this.changed[r],delete this._pending[r]):(this.changed[r]=a,i.silent||(this._pending[r]=!0));return i.silent||this.change(i),this},unset:function(e,t){return(t||(t={})).unset=!0,this.set(e,null,t)},clear:function(e){return(e||(e={})).unset=!0,this.set(o.clone(this.attributes),e)},fetch:function(t){t=t?o.clone(t):{};var i=this,n=t.success;return t.success=function(e,r,o){return i.set(i.parse(e,o),t)?(n&&n(i,e),void 0):!1},t.error=e.wrapError(t.error,i,t),(this.sync||e.sync).call(this,"read",this,t)},save:function(t,i,n){var r,a;if(o.isObject(t)||null==t?(r=t,n=i):(r={},r[t]=i),n=n?o.clone(n):{},n.wait){if(!this._validate(r,n))return!1;a=o.clone(this.attributes)}var s=o.extend({},n,{silent:!0});if(r&&!this.set(r,n.wait?s:n))return!1;var l=this,u=n.success;n.success=function(e,t,i){var a=l.parse(e,i);return n.wait&&(delete n.wait,a=o.extend(r||{},a)),l.set(a,n)?(u?u(l,e):l.trigger("sync",l,e,n),void 0):!1},n.error=e.wrapError(n.error,l,n);var c=this.isNew()?"create":"update",d=(this.sync||e.sync).call(this,c,this,n);return n.wait&&this.set(a,s),d},destroy:function(t){t=t?o.clone(t):{};var i=this,n=t.success,r=function(){i.trigger("destroy",i,i.collection,t)};if(this.isNew())return r(),!1;t.success=function(e){t.wait&&r(),n?n(i,e):i.trigger("sync",i,e,t)},t.error=e.wrapError(t.error,i,t);var a=(this.sync||e.sync).call(this,"delete",this,t);return t.wait||r(),a},url:function(){var e=I(this,"urlRoot")||I(this.collection,"url")||x();return this.isNew()?e:e+("/"==e.charAt(e.length-1)?"":"/")+encodeURIComponent(this.id)},parse:function(e){return e},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return null==this.id},change:function(e){e||(e={});var t=this._changing;this._changing=!0;for(var i in this._silent)this._pending[i]=!0;var n=o.extend({},e.changes,this._silent);this._silent={};for(var i in n)this.trigger("change:"+i,this,this.get(i),e);if(t)return this;for(;!o.isEmpty(this._pending);){this._pending={},this.trigger("change",this,e);for(var i in this.changed)this._pending[i]||this._silent[i]||delete this.changed[i];this._previousAttributes=o.clone(this.attributes)}return this._changing=!1,this},hasChanged:function(e){return arguments.length?o.has(this.changed,e):!o.isEmpty(this.changed)},changedAttributes:function(e){if(!e)return this.hasChanged()?o.clone(this.changed):!1;var t,i=!1,n=this._previousAttributes;for(var r in e)o.isEqual(n[r],t=e[r])||((i||(i={}))[r]=t);return i},previous:function(e){return arguments.length&&this._previousAttributes?this._previousAttributes[e]:null},previousAttributes:function(){return o.clone(this._previousAttributes)},isValid:function(){return!this.validate(this.attributes)},_validate:function(e,t){if(t.silent||!this.validate)return!0;e=o.extend({},this.attributes,e);var i=this.validate(e,t);return i?(t&&t.error?t.error(this,i,t):this.trigger("error",this,i,t),!1):!0}});var c=e.Collection=function(e,t){t||(t={}),t.model&&(this.model=t.model),t.comparator&&(this.comparator=t.comparator),this._reset(),this.initialize.apply(this,arguments),e&&this.reset(e,{silent:!0,parse:t.parse})};o.extend(c.prototype,l,{model:u,initialize:function(){},toJSON:function(e){return this.map(function(t){return t.toJSON(e)})},add:function(e,t){var i,n,a,s,l,u,c={},d={},p=[];for(t||(t={}),e=o.isArray(e)?e.slice():[e],i=0,a=e.length;a>i;i++){if(!(s=e[i]=this._prepareModel(e[i],t)))throw Error("Can't add an invalid model to a collection");l=s.cid,u=s.id,c[l]||this._byCid[l]||null!=u&&(d[u]||this._byId[u])?p.push(i):c[l]=d[u]=s}for(i=p.length;i--;)e.splice(p[i],1);for(i=0,a=e.length;a>i;i++)(s=e[i]).on("all",this._onModelEvent,this),this._byCid[s.cid]=s,null!=s.id&&(this._byId[s.id]=s);if(this.length+=a,n=null!=t.at?t.at:this.models.length,r.apply(this.models,[n,0].concat(e)),this.comparator&&this.sort({silent:!0}),t.silent)return this;for(i=0,a=this.models.length;a>i;i++)c[(s=this.models[i]).cid]&&(t.index=i,s.trigger("add",s,this,t));return this},remove:function(e,t){var i,n,r,a;for(t||(t={}),e=o.isArray(e)?e.slice():[e],i=0,n=e.length;n>i;i++)a=this.getByCid(e[i])||this.get(e[i]),a&&(delete this._byId[a.id],delete this._byCid[a.cid],r=this.indexOf(a),this.models.splice(r,1),this.length--,t.silent||(t.index=r,a.trigger("remove",a,this,t)),this._removeReference(a));return this},push:function(e,t){return e=this._prepareModel(e,t),this.add(e,t),e},pop:function(e){var t=this.at(this.length-1);return this.remove(t,e),t},unshift:function(e,t){return e=this._prepareModel(e,t),this.add(e,o.extend({at:0},t)),e},shift:function(e){var t=this.at(0);return this.remove(t,e),t},get:function(e){return null==e?void 0:this._byId[null!=e.id?e.id:e]},getByCid:function(e){return e&&this._byCid[e.cid||e]},at:function(e){return this.models[e]},where:function(e){return o.isEmpty(e)?[]:this.filter(function(t){for(var i in e)if(e[i]!==t.get(i))return!1;return!0})},sort:function(e){if(e||(e={}),!this.comparator)throw Error("Cannot sort a set without a comparator");var t=o.bind(this.comparator,this);return 1==this.comparator.length?this.models=this.sortBy(t):this.models.sort(t),e.silent||this.trigger("reset",this,e),this},pluck:function(e){return o.map(this.models,function(t){return t.get(e)})},reset:function(e,t){e||(e=[]),t||(t={});for(var i=0,n=this.models.length;n>i;i++)this._removeReference(this.models[i]);return this._reset(),this.add(e,o.extend({silent:!0},t)),t.silent||this.trigger("reset",this,t),this},fetch:function(t){t=t?o.clone(t):{},void 0===t.parse&&(t.parse=!0);var i=this,n=t.success;return t.success=function(e,r,o){i[t.add?"add":"reset"](i.parse(e,o),t),n&&n(i,e)},t.error=e.wrapError(t.error,i,t),(this.sync||e.sync).call(this,"read",this,t)},create:function(e,t){var i=this;if(t=t?o.clone(t):{},e=this._prepareModel(e,t),!e)return!1;t.wait||i.add(e,t);var n=t.success;return t.success=function(r,o){t.wait&&i.add(r,t),n?n(r,o):r.trigger("sync",e,o,t)},e.save(null,t),e},parse:function(e){return e},chain:function(){return o(this.models).chain()},_reset:function(){this.length=0,this.models=[],this._byId={},this._byCid={}},_prepareModel:function(e,t){if(t||(t={}),e instanceof u)e.collection||(e.collection=this);else{var i=e;t.collection=this,e=new this.model(i,t),e._validate(e.attributes,t)||(e=!1)}return e},_removeReference:function(e){this==e.collection&&delete e.collection,e.off("all",this._onModelEvent,this)},_onModelEvent:function(e,t,i,n){("add"!=e&&"remove"!=e||i==this)&&("destroy"==e&&this.remove(t,n),t&&e==="change:"+t.idAttribute&&(delete this._byId[t.previous(t.idAttribute)],this._byId[t.id]=t),this.trigger.apply(this,arguments))}});var d=["forEach","each","map","reduce","reduceRight","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","sortBy","sortedIndex","toArray","size","first","initial","rest","last","without","indexOf","shuffle","lastIndexOf","isEmpty","groupBy"];o.each(d,function(e){c.prototype[e]=function(){return o[e].apply(o,[this.models].concat(o.toArray(arguments)))}});var p=e.Router=function(e){e||(e={}),e.routes&&(this.routes=e.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},h=/:\w+/g,f=/\*\w+/g,_=/[-[\]{}()+?.,\\^$|#\s]/g;o.extend(p.prototype,l,{initialize:function(){},route:function(t,i,n){return e.history||(e.history=new g),o.isRegExp(t)||(t=this._routeToRegExp(t)),n||(n=this[i]),e.history.route(t,o.bind(function(r){var o=this._extractParameters(t,r);n&&n.apply(this,o),this.trigger.apply(this,["route:"+i].concat(o)),e.history.trigger("route",this,i,o)},this)),this},navigate:function(t,i){e.history.navigate(t,i)},_bindRoutes:function(){if(this.routes){var e=[];for(var t in this.routes)e.unshift([t,this.routes[t]]);for(var i=0,n=e.length;n>i;i++)this.route(e[i][0],e[i][1],this[e[i][1]])}},_routeToRegExp:function(e){return e=e.replace(_,"\\$&").replace(h,"([^/]+)").replace(f,"(.*?)"),RegExp("^"+e+"$")},_extractParameters:function(e,t){return e.exec(t).slice(1)}});var g=e.History=function(){this.handlers=[],o.bindAll(this,"checkUrl")},y=/^[#\/]/,m=/msie [\w.]+/;g.started=!1,o.extend(g.prototype,l,{interval:50,getHash:function(e){var t=e?e.location:window.location,i=t.href.match(/#(.*)$/);return i?i[1]:""},getFragment:function(e,t){if(null==e)if(this._hasPushState||t){e=window.location.pathname;var i=window.location.search;i&&(e+=i)}else e=this.getHash();return e.indexOf(this.options.root)||(e=e.substr(this.options.root.length)),e.replace(y,"")},start:function(e){if(g.started)throw Error("Backbone.history has already been started");g.started=!0,this.options=o.extend({},{root:"/"},this.options,e),this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&window.history&&window.history.pushState);var t=this.getFragment(),i=document.documentMode,n=m.exec(navigator.userAgent.toLowerCase())&&(!i||7>=i);n&&(this.iframe=a('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(t)),this._hasPushState?a(window).bind("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!n?a(window).bind("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=t;var r=window.location,s=r.pathname==this.options.root;return this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!s?(this.fragment=this.getFragment(null,!0),window.location.replace(this.options.root+"#"+this.fragment),!0):(this._wantsPushState&&this._hasPushState&&s&&r.hash&&(this.fragment=this.getHash().replace(y,""),window.history.replaceState({},document.title,r.protocol+"//"+r.host+this.options.root+this.fragment)),this.options.silent?void 0:this.loadUrl())},stop:function(){a(window).unbind("popstate",this.checkUrl).unbind("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),g.started=!1},route:function(e,t){this.handlers.unshift({route:e,callback:t})},checkUrl:function(){var e=this.getFragment();return e==this.fragment&&this.iframe&&(e=this.getFragment(this.getHash(this.iframe))),e==this.fragment?!1:(this.iframe&&this.navigate(e),this.loadUrl()||this.loadUrl(this.getHash()),void 0)},loadUrl:function(e){var t=this.fragment=this.getFragment(e),i=o.any(this.handlers,function(e){return e.route.test(t)?(e.callback(t),!0):void 0});return i},navigate:function(e,t){if(!g.started)return!1;t&&t!==!0||(t={trigger:t});var i=(e||"").replace(y,"");this.fragment!=i&&(this._hasPushState?(0!=i.indexOf(this.options.root)&&(i=this.options.root+i),this.fragment=i,window.history[t.replace?"replaceState":"pushState"]({},document.title,i)):this._wantsHashChange?(this.fragment=i,this._updateHash(window.location,i,t.replace),this.iframe&&i!=this.getFragment(this.getHash(this.iframe))&&(t.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,i,t.replace))):window.location.assign(this.options.root+e),t.trigger&&this.loadUrl(e))},_updateHash:function(e,t,i){i?e.replace((""+e).replace(/(javascript:|#).*$/,"")+"#"+t):e.hash=t}});var v=e.View=function(e){this.cid=o.uniqueId("view"),this._configure(e||{}),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},w=/^(\S+)\s*(.*)$/,b=["model","collection","el","id","attributes","className","tagName"];o.extend(v.prototype,l,{tagName:"div",$:function(e){return this.$el.find(e)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this},make:function(e,t,i){var n=document.createElement(e);return t&&a(n).attr(t),i&&a(n).html(i),n},setElement:function(e,t){return this.$el&&this.undelegateEvents(),this.$el=e instanceof a?e:a(e),this.el=this.$el[0],t!==!1&&this.delegateEvents(),this},delegateEvents:function(e){if(e||(e=I(this,"events"))){this.undelegateEvents();for(var t in e){var i=e[t];if(o.isFunction(i)||(i=this[e[t]]),!i)throw Error('Method "'+e[t]+'" does not exist');var n=t.match(w),r=n[1],a=n[2];i=o.bind(i,this),r+=".delegateEvents"+this.cid,""===a?this.$el.bind(r,i):this.$el.delegate(a,r,i)}}},undelegateEvents:function(){this.$el.unbind(".delegateEvents"+this.cid)},_configure:function(e){this.options&&(e=o.extend({},this.options,e));for(var t=0,i=b.length;i>t;t++){var n=b[t];e[n]&&(this[n]=e[n])}this.options=e},_ensureElement:function(){if(this.el)this.setElement(this.el,!1);else{var e=I(this,"attributes")||{};this.id&&(e.id=this.id),this.className&&(e["class"]=this.className),this.setElement(this.make(this.tagName,e),!1)}}});var T=function(e,t){var i=S(this,e,t);return i.extend=this.extend,i};u.extend=c.extend=p.extend=v.extend=T;var A={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};e.sync=function(t,i,n){var r=A[t];n||(n={});var s={type:r,dataType:"json"};return n.url||(s.url=I(i,"url")||x()),n.data||!i||"create"!=t&&"update"!=t||(s.contentType="application/json",s.data=JSON.stringify(i.toJSON())),e.emulateJSON&&(s.contentType="application/x-www-form-urlencoded",s.data=s.data?{model:s.data}:{}),e.emulateHTTP&&("PUT"===r||"DELETE"===r)&&(e.emulateJSON&&(s.data._method=r),s.type="POST",s.beforeSend=function(e){e.setRequestHeader("X-HTTP-Method-Override",r)}),"GET"===s.type||e.emulateJSON||(s.processData=!1),a.ajax(o.extend(s,n))},e.wrapError=function(e,t,i){return function(n,r){r=n===t?r:n,e?e(t,r,i):t.trigger("error",t,r,i)}};var E=function(){},S=function(e,t,i){var n;return n=t&&t.hasOwnProperty("constructor")?t.constructor:function(){e.apply(this,arguments)},o.extend(n,e),E.prototype=e.prototype,n.prototype=new E,t&&o.extend(n.prototype,t),i&&o.extend(n,i),n.prototype.constructor=n,n.__super__=e.prototype,n},I=function(e,t){return e&&e[t]?o.isFunction(e[t])?e[t]():e[t]:null},x=function(){throw Error('A "url" property or function must be specified')}}).call(this);