define(["Ti/_/declare","Ti/_/dom","Ti/_/event","Ti/_/lang","Ti/Media","Ti/UI/View"],function(e,a,t,i,n,s){function o(e){return k?!!r.mozFullScreen||!!r.webkitIsFullScreen:!!e}var r=document,_=require.on,l=require.config.vendorPrefixes.dom,d=0,c=1,u=2,p=3,m="requestFullScreen",g="exitFullScreen",k=function(){for(var e,a=0;l.length>a;a++)if(e=l[a].toLowerCase(),r[e+"CancelFullScreen"])return m=e+"RequestFullScreen",g=e+"ExitFullScreen",1;return!!r.cancelFullScreen}(),b=!0,h={m4v:"video/mp4",mov:"video/quicktime",mp4:"video/mp4",ogg:"video/ogg",ogv:"video/ogg",webm:"video/webm"};return e("Ti.Media.VideoPlayer",s,{_currentState:d,constructor:function(){this._handles=[]},properties:{autoplay:!1,currentPlaybackTime:{get:function(){return this._video?1e3*this._video.currentTime:0},set:function(e){return this._video&&(this._video.currentTime=0|e/1e3),e}},fullscreen:{value:o(),set:function(e){var a,t=this._video;if(e=!!e,k)try{e===o()&&(e=!e),t[e?m:g]()}catch(i){}else b&&(t.className=e?"fullscreen":"",e&&(a=_(window,"keydown",function(e){27===e.keyCode&&(this.fullscreen=0,a())})));return this.fireEvent("fullscreen",{entering:e}),e}},mediaControlStyle:{value:n.VIDEO_CONTROL_DEFAULT,set:function(e){return this._video&&(this._video.controls=e===n.VIDEO_CONTROL_DEFAULT),e}},repeatMode:n.VIDEO_REPEAT_MODE_NONE,scalingMode:{set:function(e){var a=this.domNode,t=n.VIDEO_SCALING_ASPECT_FIT,i={};return i[n.VIDEO_SCALING_NONE]="TiScalingNone",i[t]="TiScalingAspectFit",a.className=a.className.replace(/(scaling\-[\w\-]+)/,"")+" "+(i[e]||i[e=t]),e}},url:{set:function(e){return this.constants.playing=!1,this._currentState=d,this.properties.__values__.url=e,this._createVideo(),e}}},constants:{playbackState:n.VIDEO_PLAYBACK_STATE_STOPPED,playing:!1,initialPlaybackTime:0,endPlaybackTime:0,playableDuration:0,loadState:n.VIDEO_LOAD_STATE_UNKNOWN,duration:0},_set:function(e,a){var t={};t[e]=this.constants[e]=a,this.fireEvent(e.toLowerCase(),t)},_complete:function(e){var a="ended"===e.type;this.constants.playing=!1,this._currentState=d,this.fireEvent("complete",{reason:a?n.VIDEO_FINISH_REASON_PLAYBACK_ENDED:n.VIDEO_FINISH_REASON_USER_EXITED}),a&&this.repeatMode===n.VIDEO_REPEAT_MODE_ONE&&setTimeout(i.hitch(this,function(){this._video.play()}),1)},_stalled:function(){this._set("loadState",n.VIDEO_LOAD_STATE_STALLED)},_fullscreenChange:function(){this.properties.__values__.fullscreen=!o(this.fullscreen)},_durationChange:function(){var e=1e3*this._video.duration,a=this.constants;1/0!==e&&(this.duration||this.fireEvent("durationavailable",{duration:e}),a.duration=a.playableDuration=a.endPlaybackTime=e)},_paused:function(){var e=n.VIDEO_PLAYBACK_STATE_STOPPED;this.constants.playing=!1,this._currentState===p?(this._currentState=u,e=n.VIDEO_PLAYBACK_STATE_PAUSED):this._currentState===c&&(this._video.currentTime=0),this._set("playbackState",e)},_createVideo:function(e){var t,i,s=this._video,o=this.url;if(o){if(e&&s&&s.parentNode)return s;for(this.release(),s=this._video=a.create("video",{tabindex:0}),this.mediaControlStyle===n.VIDEO_CONTROL_DEFAULT&&(s.controls=1),this.scalingMode=n.VIDEO_SCALING_ASPECT_FIT,this._handles=[_(s,"playing",this,function(){this._currentState=p,this.constants.playing=!0,this.fireEvent("playing",{url:s.currentSrc}),this._set("playbackState",n.VIDEO_PLAYBACK_STATE_PLAYING)}),_(s,"pause",this,"_paused"),_(s,"canplay",this,function(){this._set("loadState",n.VIDEO_LOAD_STATE_PLAYABLE),this._currentState===d&&this.autoplay&&s.play()}),_(s,"canplaythrough",this,function(){this._set("loadState",n.VIDEO_LOAD_STATE_PLAYTHROUGH_OK),this.fireEvent("preload")}),_(s,"loadeddata",this,function(){this.fireEvent("load")}),_(s,"loadedmetadata",this,"_durationChange"),_(s,"durationchange",this,"_durationChange"),_(s,"timeupdate",this,function(){this.constants.currentPlaybackTime=1e3*this._video.currentTime,this._currentState===c&&this.pause()}),_(s,"error",this,function(){var e="Unknown error";switch(s.error.code){case 1:e="Aborted";break;case 2:e="Decode error";break;case 3:e="Network error";break;case 4:e="Unsupported format"}this.constants.playing=!1,this._set("loadState",n.VIDEO_LOAD_STATE_UNKNOWN),this.fireEvent("error",{message:e}),this.fireEvent("complete",{reason:n.VIDEO_FINISH_REASON_PLAYBACK_ERROR})}),_(s,"abort",this,"_complete"),_(s,"ended",this,"_complete"),_(s,"stalled",this,"_stalled"),_(s,"waiting",this,"_stalled"),_(s,"mozfullscreenchange",this,"_fullscreenChange"),_(s,"webkitfullscreenchange",this,"_fullscreenChange")],this.domNode.appendChild(s),require.is(o,"Array")||(o=[o]),t=0;o.length>t;t++)i=o[t].match(/.+\.([^\/\.]+?)$/),a.create("source",{src:o[t],type:i&&h[i[1]]},s);return s}},play:function(){this._currentState!==p&&this._createVideo(1).play()},pause:function(){this._currentState===p&&this._createVideo(1).pause()},destroy:function(){this.release(),s.prototype.destroy.apply(this,arguments)},release:function(){var e=this._video,a=e&&e.parentNode;this._currentState=d,this.constants.playing=!1,a&&(t.off(this._handles),a.removeChild(e)),this._video=null},stop:function(){var e=this._video;this._currentState=c,e&&(e.pause(),e.currentTime=0)}})});