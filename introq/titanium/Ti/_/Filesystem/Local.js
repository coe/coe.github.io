define(["Ti/_","Ti/_/declare","Ti/_/encoding","Ti/_/lang","Ti/API","Ti/Blob"],function(e,a,t,i,n,s){function o(e,a){return f.getItem("ti:fs:"+(a?"meta:":"blob:")+e)}function r(e,a,t){return f.setItem("ti:fs:"+(t?"meta:":"blob:")+e,a),a.length}function _(e){var a=new XMLHttpRequest;return a.overrideMimeType("text/plain; charset=x-user-defined"),a.open("GET","."+e,!1),a.send(null),200===a.status?{data:a.responseText,mimeType:a.getResponseHeader("Content-Type")}:null}function l(e){var a,t=[];return g||(g={"/":"tD\nr1"},require("./titanium/filesystem.registry").split(/\n|\|/).forEach(function(e,a){var i,n=0,e=e.split("	"),s=e.length;if(0===a&&"ts"===e[0])h=e[1],g[v]+="\nc"+h;else{for(;s>n&&!e[n];n++);t=t.slice(0,n).concat(i=e[n]),g[v+t.join(v)]="n"+i+"\nt"+(n+1==s?"D":"F\ns"+e[n+1])}})),(a=g[e])&&a+"\nr1\ne1\nc"+h+"\nm"+h}function d(){return b||(b=require("Ti/Filesystem"))}function c(e,a,t,i){var s,t=t||1,o=e+a.slice(0,t).join(v);return i&&i.readonly?(n.error('Unable to create "'+o+'" because parent is readonly'),!1):(s=new k({nativePath:o,type:"D"}),s.createDirectory(),++t>a.length?!0:c(e,a,t,s))}function u(e){if(e){var a=e.match(P),t=(a[1]?a[1]:a[2]+a[3])||v;return e=a[1]?a[2]:a[4],e?c(t,e.split(v)):!0}return!1}function p(e,a){var t,i,n=e.nativePath,s=RegExp("^(ti:fs:meta|ti:fs:blob):"+n+(/\/$/.test(n)?"":v)+"(.*)"),o=0,r=f.length;if(a=d().getFile(a.nativePath,e.name),u(a.nativePath)){for(;r>o;)i=f.key(o++),(t=i.match(s))&&f.setItem(t[1]+":"+a.nativePath+v+t[2],f.getItem(i)||"");return!0}return!1}function m(){for(var e,a=/^ti:fs:tmp:\/\//,t=0,i=f.length;i>t;)e=f.key(t++),a.test(e)&&f.removeItem(e)}var g,k,b,h=Date.now(),y=require.is,f=localStorage,v="/",w={n:"sname",c:"i_created",m:"i_modified",t:"s_type",y:"s_mimeType",e:"b_remote",x:"bexecutable",r:"breadonly",s:"isize",l:"bsymbolicLink",h:"bhidden"},z={i:function(e){return e-0},s:function(e){return""+e},b:function(e){return!!(0|e)}},S="ti:fs:meta:",j="ti:fs:blob:",P=/(\/)?([^\:]*)(\:\/\/)?(.*)/,A="application/octet-stream,text/plain,text/html,text/css,text/xml,text/mathml,image/gif,image/jpeg,image/png,image/x-icon,image/svg+xml,application/x-javascript,application/json,application/pdf,application/x-opentype,audio/mpeg,video/mpeg,video/quicktime,video/x-flv,video/x-ms-wmv,video/x-msvideo,video/ogg,video/mp4,video/webm,text/csv".split(","),T={txt:1,html:2,htm:2,css:3,xml:4,mml:5,gif:6,jpeg:7,jpg:7,png:8,ico:9,svg:10,js:11,json:12,pdf:13,otf:14,mp3:15,mpeg:16,mpg:16,mov:17,flv:18,wmv:19,avi:20,ogg:21,ogv:21,mp4:22,m4v:22,webm:23,csv:24};return m(),require.on(window,"beforeunload",m),function(e,a){for(var t in e)o(t,1)||r(t,"c"+a+"\nm"+a+"\ntD\ne0\nx0\nl0\nh0\nr"+e[t],1)}({"appdata://":0,"/":1,"tmp://":0},Date.now()),k=a("Ti._.Filesystem.Local",null,{constructor:function(e){if(y(e,"String")){var a=e.match(P),t=!a[1]&&a[3];if(/^\.\./.test(e=t?a[4]:a[2]))throw Error('Irrational path "'+e+'"');this.constants.__values__.nativePath=(t?a[2]+"://":v)+e}this._type=e&&"D"!==e._type?"F":"D"},postscript:function(){var e,a,t=this.constants,i=this.nativePath,n=i&&o(i,1)||l(i),s=i.match(P),r=(s[1]?s[1]:s[2]+s[3])||v;n&&(this._exists=1)&&n.split("\n").forEach(function(e){var a=w[e.charAt(0)],i=a.substring(1),n=z[a.charAt(0)](e.substring(1));(t.hasOwnProperty(i)?t.__values__:this)[i]=n},this),i=s[1]?s[2]:s[4],e=i.split(v),t.name=e.pop(),e=e.join(v),a=t.parent=i?new k(r+e):null,a&&a.readonly||s&&s[1]&&(t.readonly=!0)},constants:{name:"",executable:!1,readonly:!1,size:0,symbolicLink:!1,nativePath:"",parent:null,writable:{get:function(){return!this.readonly},set:function(e){return this.constants.__value__.readonly=!e},value:!0}},properties:{hidden:!1},append:function(e){if(this.isFile()){switch(e&&e.declaredClass){case"Ti.Filesystem.File":e=e.read();case"Ti.Blob":this._mimeType=e.mimeType,e=e.text}var a=this.read();return a.append(e),this.write(a)}return!1},copy:function(e){if(this.exists&&e){var a=d(),e="Ti.Filesystem.File"===e.declaredClass?e:a.getFile.apply(null,arguments),t=e.parent,i=this.isFile();return e.exists()?e.readonly?!1:e.isFile()?i?e.write(this.read()):(Ti.API.error("Destination is not a directory"),!1):i?a.getFile(e.nativePath,this.name).write(this.read()):p(this,e):t&&(t.createDirectory(),!t.exists()||t.readonly||!i&&!e.createDirectory())?!1:i?e.write(this.read()):p(this,e)}return!1},createDirectory:function(){return this._create("D")},createFile:function(){return this._create("F")},createTimestamp:function(){return this._created||null},deleteDirectory:function(e){if(this.isDirectory()&&!this.readonly){for(var a=this.nativePath,t=RegExp("^ti:fs:(meta|blob):"+a+(/\/$/.test(a)?"":v)+".*"),i=0,n=f.length;n>i;)if(t.test(key=f.key(i++))){if(!e)return Ti.API.error('Directory "'+a+'" not empty'),!1;f.removeItem(key)}return this._exists=0,f.removeItem(S+a),f.removeItem(j+a),!0}return!1},deleteFile:function(){if(this.exists()&&this.isFile()&&!this.readonly){var e=this.nativePath;return this._exists=0,f.removeItem(S+e),f.removeItem(j+e),!0}return!1},exists:function(){return!!this._exists},extension:function(){var e=this.name.match(/\.(.+)$/);return e?e[1]:""},getDirectoryListing:function(){function e(e,t){var i,n=e.match(t);n&&n[1]&&0>a.indexOf(i=n[1].split(v)[0])&&a.push(i)}var a=[];if(this.isDirectory()){for(var t=this.nativePath+(/\/$/.test(this.nativePath)?"":v),i=RegExp("^"+S+t+"(.*)"),n=RegExp("^"+t+"(.*)"),s=0,o=f.length;o>s;)e(f.key(s++),i);for(s in g)e(s,n)}return a.sort()},isDirectory:function(){return"D"===this._type},isFile:function(){return"F"===this._type},modificationTimestamp:function(){return this._modified||null},move:function(){return this.copy.apply(this,arguments)&&this[this.isFile()?"deleteFile":"deleteDirectory"](1)},open:function(e){var a=require("Ti/Filesystem/FileStream");return this.exists()&&this.isFile()?new a({mode:e,data:this.read().text}):null},read:function(){if(this.exists()&&this.isFile()){var a,t=this.nativePath,i=this._remote?(a=_(t)).data:o(t)||"",n=A[T[this.extension()]||0],r=a&&a.mimeType||this._mimeType||n,l=0,d=i.length,c="",u={file:this,data:i,length:d,mimeType:r="application/octet-stream"===r&&r!==n?n:r,nativePath:t};if(this._remote&&e.isBinaryMimeType(r)){for(;d>l;)c+=String.fromCharCode(255&i.charCodeAt(l++));u.data=btoa(c)}return new s(u)}return null},rename:function(e){if(this.exists&&!this.readonly){var a,t,i=this.nativePath,n=i,s=f.getItem(j+n),o=RegExp("^ti:fs:(meta|blob):"+n+(/\/$/.test(n)?"":v)+"(.*)"),r=n.match(P),_=(r[1]?r[1]:r[2]+r[3])||v,l=0,d=f.length;if(this.constants.__values__,n=r[1]?r[2]:r[4],!n)return Ti.API.error("Can't rename root \""+_+'"'),!1;if(n=n.split(v),n.pop(),n.push(e),a=new k(n=_+n.join(v)),a.exists()||a.parent.readonly)return!1;if("D"===this._type)for(;d>l;)t=f.key(l++),(r=t.match(o))&&(f.setItem("ti:fs:"+r[1]+":"+n+v+r[2],f.getItem(t)),f.removeItem(t));return this._save(n,e),s&&f.setItem(j+n,s),f.removeItem(S+i),f.removeItem(j+i),!0}return!1},resolve:function(){return this.nativePath},spaceAvailable:function(){return"remainingSpace"in f?f.remainingSpace:null},write:function(e,a){var t=this.nativePath;if(t&&this.isFile()&&!this.readonly&&this.parent&&!this.parent.readonly){switch(e&&y(e,"String")&&(this._mimeType=A[1]),e&&e.declaredClass){case"Ti.Filesystem.File":e=e.read();case"Ti.Blob":this._mimeType=e.mimeType,e=e._data||""}return this._exists=1,this._modified=Date.now(),this._created||(this._created=this._modified),this.constants.__values__.size=r(t,a?this.read()+e:e),this._save()}return!1},_create:function(e){return!this.exists()&&this.parent&&!this.parent.readonly&&u(this.parent.nativePath)?(this._created=this._modified=Date.now(),this._exists=1,this._type=e,this._save()):!1},_save:function(e,a){var t,e=e||this.nativePath;return e?(t=["n",a||this.name,"\nc",this._created,"\nm",this._modified,"\nt",this._type,"\ne0\nx0\nr",0|this.readonly,"\nl",0|this.symbolicLink,"\nh",0|this.hidden],"F"===this._type&&t.push("\ns"+this.size),this._mimeType&&t.push("\ny"+this._mimeType),r(e,t.join(""),1),!0):!1}})});