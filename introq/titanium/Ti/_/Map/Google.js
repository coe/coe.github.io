define(["Ti/_/declare","Ti/_/dom","Ti/_/event","Ti/_/lang","Ti/App/Properties","Ti/Geolocation","Ti/Map","Ti/UI/View","Ti/Utils"],function(e,a,t,i,n,s,o,r,_){function l(e){var a=d.MapTypeId;switch(e){case o.HYBRID_TYPE:return a.HYBRID;case o.SATELLITE_TYPE:return a.SATELLITE;case o.TERRAIN_TYPE:return a.TERRAIN}return a.ROADMAP}var d,c,u,p,m=i.isDef,g=require.mix,k=require.on,b=r.prototype.fireEvent,h={latitude:39.828175,longitude:-98.5795,latitudeDelta:30.137412,longitudeDelta:63.235658},y={0:"red",1:"green",2:"purple"},f=Ti.deferStart(),v=e("Ti.Map.View",r,{constructor:function(){this.properties.__values__.annotations=[],this._annotationMap={},this._routes=[],this.fireEvent("loading")},postscript:function(){var e=this,a=e.region||h,t=e._gmap=new d.Map(e.domNode,{disableDefaultUI:!0,zoom:2,zoomControl:!0,center:new d.LatLng(a.latitude,a.longitude),mapTypeId:l(e.mapType)});k(e,"postlayout",function(){c.trigger(t,"resize"),e._updateMap(a,1),setTimeout(function(){e._updateMap(a,1),e._updateUserLocation(e.userLocation),e.annotations.forEach(e._createMarker,e),e._annotationEvents=[],e._boundsEvt=c.addListener(t,"bounds_changed",i.hitch(e,"_fitRegion"))},1)})},destroy:function(){t.off(this._annotationEvents),c.removeListener(this._boundsEvt),c.clearInstanceListeners(this._gmap),this.removeAllAnnotations(),this._gmap=null,r.prototype.destroy.apply(this,arguments)},addAnnotation:function(e){e&&("Ti.Map.Annotation"===e.declaredClass||(e=new Annotation(e)),~this.annotations.indexOf(e)||this._createMarker(e),e.title&&(this._annotationMap[e.title]=e))},addAnnotations:function(e){e&&e.forEach(this.addAnnotation,this)},addRoute:function(e){e&&(e.points||[]).length&&(e.pline=new d.Polyline({map:this._gmap,path:e.points.map(function(e){return new d.LatLng(e.latitude,e.longitude)}),strokeColor:e.color||"#000",strokeWeight:e.width||1}),this._routes.push(e))},deselectAnnotation:function(e){require.is(e,"String")&&(e=this._annotationMap[e]),e&&u&&u.widgetId===e.widgetId&&this._hide(e)},removeAllAnnotations:function(){for(u&&u.close();this.annotations.length;)this.removeAnnotation(this.annotations[0])},removeAnnotation:function(e){if(require.is(e,"String")&&(e=this._annotationMap[e]),e){var a=this.properties.__values__.annotations,t=a.indexOf(e);u&&this._hide(e),c.removeListener(e.evt),e.marker.setMap(null),delete e.marker,e.destroy(),~t&&a.splice(t,1)}},removeAnnotations:function(e){e.forEach(function(e){this.removeAnnotation(e)},this)},removeRoute:function(e){if(e&&e.name)for(var a=this._routes,t=0;a.length>t;t++)a[t].name===e.name&&(e.pline.setMap(null),delete e.pline,a.splice(t--,1))},selectAnnotation:function(e){require.is(e,"String")&&(e=this._annotationMap[e]),e&&this._show(e)},setLocation:function(e){e&&(this.region=e),m(e.animate)&&(this.animated=e.animate),m(e.animated)&&(this.animated=e.animated),m(e.regionFit)&&(this.regionFit=e.regionFit),this._updateMap(e)},zoom:function(e){var a=this._gmap;a.setZoom(a.getZoom()+e)},_show:function(e,i){function n(){o||(o=1)&&r._dispatchEvents(e,i)}if(e&&(!u||u.widgetId!==e.widgetId)){var s,o,r=this,_=e.widgetId,l="TiMapAnnotation",p=a.create("div",{className:l}),m=p,g={annotation:m,leftButton:e.leftButton&&a.create("img",{className:l+"LeftButton",src:e.leftButton},p),rightButton:e.rightButton&&a.create("img",{className:l+"RightButton",src:e.rightButton},p),dummy:(p=a.create("div",{className:l+"Content"},p))&&0,title:a.create("h1",{innerHTML:e._getTitle()},p),subtitle:a.create("p",{innerHTML:e._getSubtitle()},p)};t.off(r._annotationEvents);for(s in g)(function(a,i){i&&r._annotationEvents.push(k(i,"click",function(i){t.stop(i),r._hide(e,a)}))})(s,g[s]);r._annotationEvents.push(k(e,"update",this,function(a){if(u.widgetId===_){var t,i=a.property,n=a.value,s=this._annotationMap;switch(i){case"title":case"subtitle":g[i].innerHTML=n,delete s[a.oldValue],n&&(s[n]=e);break;case"leftButton":case"rightButton":g[i].src=n;break;case"image":case"pincolor":t=r._getMarkerImage(e),e.marker.setIcon(t[0]),e.marker.setShadow(t[1]||null)}}})),u?(n(),u.setContent(m)):(u=new d.InfoWindow({content:m}),c.addListener(u,"domready",n),c.addListener(u,"closeclick",function(){r._hide(e,"annotation")})),u.open(r._gmap,e.marker),u.widgetId=e.widgetId}},_hide:function(e,a){a&&~a.indexOf("Button")||(u.close(),u.widgetId=0),this._dispatchEvents(e,a)},_dispatchEvents:function(e,a){var t=this.annotations.indexOf(e),i={annotation:e,clicksource:a=a||"pin",index:t,latitude:e.latitude,longitude:e.longitude,map:this,subtitle:e._getSubtitle(),title:e._getTitle()};b.call(this,"singletap",i),b.call(this,"click",i),e._onclick(this,t,a)},_getMarkerImage:function(e){var a,t,i=y[0|e.pincolor];return e.image&&("Ti.Blob"===e.image.declaredClass?(i=y[a=_.md5HexDigest(t=""+e.image)],i||(i=y[a]=[new d.MarkerImage(t)])):(i=y[e.image],i||(i=y[e.image]=[new d.MarkerImage(e.image)]))),i},_createMarker:function(e){var a=this._getMarkerImage(e);e.evt=c.addListener(e.marker=new d.Marker({map:this._gmap,icon:a[0],shadow:a[1],position:new d.LatLng(e.latitude,e.longitude),optimized:!1,title:e._getTitle(),animation:e.animate&&d.Animation.DROP}),"click",i.hitch(this,function(){this[u&&u.widgetId===e.widgetId?"_hide":"_show"](e)})),this.properties.__values__.annotations.push(e)},_fitRegion:function(){var e=this.constants,a=this._gmap,t=a.getCenter(),i=a.getBounds(),n=i.getNorthEast(),s=i.getSouthWest(),o=e.latitudeDelta=n.lat()-s.lat(),r=e.longitudeDelta=n.lng()-s.lng(),_={latitude:t.lat(),longitude:t.lng(),latitudeDelta:o,longitudeDelta:r};this.regionFit&&(this.properties.__values__.region=_),this._initialized||(this._initialized=1,this.fireEvent("complete")),this.fireEvent("regionchanged",_)},_updateMap:function(e,a){var t=this._gmap;if(t){var i=!a&&this.animated,n=e.latitudeDelta/2,s=e.longitudeDelta/2;t[i?"panTo":"setCenter"](new d.LatLng(e.latitude,e.longitude)),t[i?"panToBounds":"fitBounds"](new d.LatLngBounds(new d.LatLng(e.latitude-n,e.longitude-s),new d.LatLng(e.latitude+n,e.longitude+s)))}},_updateUserLocation:function(e){var a=this._gmap;a&&(e||this._locationInited)&&(this._locationInited=1,s[e?"addEventListener":"removeEventListener"]("location",i.hitch(this,function(e){var a,t=this._locationMarker,i=e.coords,n=e.code;i?(a=new d.LatLng(i.latitude,i.longitude),t?t.setPosition(a):this._locationMarker=new d.Marker({map:this._gmap,icon:p,position:a})):"code"in e&&Ti.API.warn("Geolocation error: "+(n===s.ERROR_DENIED?"permission denied":n===s.ERROR_TIMEOUT?"timeout":n===s.ERROR_LOCATION_UNKNOWN?"position unavailable":"unknown"))})),s.locationServicesEnabled?(!e||this._locationMarker)&&this._locationMarker.setVisible(e):(Ti.API.warn("Geolocation services unavailable"),this.properties.__values__.userLocation=!1))},fireEvent:function(e){/(click|singletap)/.test(e)||r.prototype.fireEvent.apply(this,arguments)},constants:{latitudeDelta:0,longitudeDelta:0},properties:{animated:!1,annotations:{set:function(e){return e=e.filter(function(e){return e&&"Ti.Map.Annotation"===e.declaredClass}),this._gmap&&(this.removeAllAnnotations(),e.forEach(this._createMarker,this)),e}},mapType:{set:function(e){return this._gmap&&this._gmap.setMapTypeId(l(e)),e}},region:{set:function(e,a){return g({},h,a,e)},post:function(e,a){e!==a&&this._updateMap(e)},value:null},regionFit:!0,userLocation:{post:function(e){this._updateUserLocation(e)},value:!1}}});return window.TiMapViewInit=function(){function e(e,a,n){return new d.MarkerImage(t+"marker_"+e+".png",new d.Size(a,34),new i(n,0),new i(10,34))}d=google.maps,c=d.event;var a,t="themes/"+require.config.ti.theme+"/Map/",i=d.Point;for(a in y)y[a]=[e(y[a],20,0),e(y[a],37,20)];p=new d.MarkerImage(t+"location.png",new d.Size(22,22),new i(0,0),new i(11,11)),f()},require(["//maps.googleapis.com/maps/api/js?key="+n.getString("ti.map.apikey","")+"&sensor=true&callback=TiMapViewInit"],0,f),v});