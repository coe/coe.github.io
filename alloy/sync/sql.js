function S4(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function guid(){return S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()}function Migrator(e,t){this.db=t,this.dbname=e.adapter.db_name,this.table=e.adapter.collection_name,this.idAttribute=e.adapter.idAttribute,this.column=function(e){var t=e.split(/\s+/),i=t[0];switch(i.toLowerCase()){case"string":case"varchar":case"date":case"datetime":Ti.API.warn('"'+i+'" is not a valid sqlite field, using TEXT instead');case"text":i="TEXT";break;case"int":case"tinyint":case"smallint":case"bigint":case"boolean":Ti.API.warn('"'+i+'" is not a valid sqlite field, using INTEGER instead');case"integer":i="INTEGER";break;case"double":case"float":case"decimal":case"number":Ti.API.warn('"'+e+'" is not a valid sqlite field, using REAL instead');case"real":i="REAL";break;case"blob":i="BLOB";break;case"null":i="NULL";break;default:i="TEXT"}return t[0]=i,t.join(" ")},this.createTable=function(e){var t=[],i=!1;for(var r in e.columns)r===this.idAttribute&&(i=!0),t.push(r+" "+this.column(e.columns[r]));i||this.idAttribute!==ALLOY_ID_DEFAULT||t.push(ALLOY_ID_DEFAULT+" TEXT UNIQUE");var o="CREATE TABLE IF NOT EXISTS "+this.table+" ( "+t.join(",")+")";this.db.execute(o)},this.dropTable=function(){this.db.execute("DROP TABLE IF EXISTS "+this.table)},this.insertRow=function(e){var t=[],i=[],r=[],o=!1;for(var n in e)n===this.idAttribute&&(o=!0),t.push(n),i.push(e[n]),r.push("?");o||this.idAttribute!==ALLOY_ID_DEFAULT||(t.push(this.idAttribute),i.push(guid()),r.push("?")),this.db.execute("INSERT INTO "+this.table+" ("+t.join(",")+") VALUES ("+r.join(",")+");",i)},this.deleteRow=function(e){var t="DELETE FROM "+this.table,i=_.keys(e),r=i.length,o=[],n=[];r&&(t+=" WHERE ");for(var s=0;r>s;s++)o.push(i[s]+" = ?"),n.push(e[i[s]]);t+=o.join(" AND "),this.db.execute(t,n)}}function Sync(e,t,i){var r,o,n=t.config.adapter.collection_name,s=t.config.columns,a=t.config.adapter.db_name||ALLOY_DB_DEFAULT,l=null;switch(e){case"create":case"update":l=function(){var e={};t.id||(t.id=t.idAttribute===ALLOY_ID_DEFAULT?guid():null,e[t.idAttribute]=t.id,"0.9.2"===backbone.VERSION?t.set(e,{silent:!0}):t.set(e));var i=[],l=[],d=[];for(var c in s)i.push(c),l.push(t.get(c)),d.push("?");return o="REPLACE INTO "+n+" ("+i.join(",")+") VALUES ("+d.join(",")+");",r=Ti.Database.open(a),r.execute(o,l),null===t.id&&(t.id=r.lastInsertRowId,e[t.idAttribute]=t.id,"0.9.2"===backbone.VERSION?t.set(e,{silent:!0}):t.set(e)),r.close(),t.toJSON()}();break;case"read":i.query&&i.id&&Ti.API.warn('Both "query" and "id" options were specified for model.fetch(). "id" will be ignored.'),o="SELECT * FROM "+n,i.query?o=i.query:i.id&&(o+=" WHERE "+(t.idAttribute?t.idAttribute:ALLOY_ID_DEFAULT)+" = "+(_.isString(i.id)?'"'+i.id+'"':i.id)),r=Ti.Database.open(a);var d;d=_.isString(o)?r.execute(o):r.execute(o.statement,o.params);for(var c=[],u=[],p=_.isFunction(d.fieldCount)?d.fieldCount():d.fieldCount,h=d.field,f=0;p>f;f++)u.push(d.fieldName(f));for(;d.isValidRow();){var y={};for(f=0;p>f;f++)y[u[f]]=h(f);c.push(y),d.next()}d.close(),r.close();var g=c.length;"0.9.2"===backbone.VERSION&&(t.length=g),l=1===g?c[0]:c;break;case"delete":o="DELETE FROM "+n+" WHERE "+t.idAttribute+"=?",r=Ti.Database.open(a),r.execute(o,t.id),r.close(),l=t.toJSON()}l?(_.isFunction(i.success)&&i.success(l),"read"!==e||i.silent||t.trigger("fetch",{fromAdapter:!0})):_.isFunction(i.error)&&i.error(l)}function GetMigrationFor(e,t){var i=null,r=Ti.Database.open(e);r.execute("CREATE TABLE IF NOT EXISTS migrations (latest TEXT, model TEXT);");var o=r.execute("SELECT latest FROM migrations where model = ?;",t);return o.isValidRow()&&(i=o.field(0)+""),o.close(),r.close(),i}function Migrate(e){var t=e.migrations||[],i={};t.length&&t[t.length-1](i);var r=e.prototype.config;r.adapter.db_name=r.adapter.db_name||ALLOY_DB_DEFAULT;var o=new Migrator(r),n="undefined"==typeof r.adapter.migration||null===r.adapter.migration?i.id:r.adapter.migration;if("undefined"==typeof n||null===n){var s=Ti.Database.open(r.adapter.db_name);return o.db=s,o.createTable(r),void s.close()}n+="";var a,l=GetMigrationFor(r.adapter.db_name,r.adapter.collection_name);if(l!==n){if(l&&l>n?(a=0,t.reverse()):a=1,db=Ti.Database.open(r.adapter.db_name),o.db=db,db.execute("BEGIN;"),t.length)for(var d=0;d<t.length;d++){var c=t[d],u={};if(c(u),a){if(u.id>n)break;if(u.id<=l)continue}else{if(u.id<=n)break;if(u.id>l)continue}var p=a?"up":"down";_.isFunction(u[p])&&u[p](o)}else o.createTable(r);db.execute("DELETE FROM migrations where model = ?",r.adapter.collection_name),db.execute("INSERT INTO migrations VALUES (?,?)",n,r.adapter.collection_name),db.execute("COMMIT;"),db.close(),o.db=null}}function installDatabase(e){var t=e.adapter.db_file,i=e.adapter.collection_name,r=/(^|.*\/)([^\/]+)\.[^\/]+$/,o=t.match(r);if(null===o)throw'Invalid sql database filename "'+t+'"';e.adapter.db_name=e.adapter.db_name||o[2];var n=e.adapter.db_name;Ti.API.debug('Installing sql database "'+t+'" with name "'+n+'"');var s=Ti.Database.install(t,n);!1===e.adapter.remoteBackup,1;var a,l,d=s.execute('pragma table_info("'+i+'");'),c={};if(d){for(;d.isValidRow();)a=d.fieldByName("name"),l=d.fieldByName("type"),c[a]=l,a!==ALLOY_ID_DEFAULT||e.adapter.idAttribute||(e.adapter.idAttribute=ALLOY_ID_DEFAULT),d.next();d.close()}else{e.adapter.idAttribute?e.adapter.idAttribute:ALLOY_ID_DEFAULT;for(var u in e.columns)a=u,l=e.columns[u],a!==ALLOY_ID_DEFAULT||e.adapter.idAttribute?u===e.adapter.idAttribute&&(l+=" UNIQUE"):e.adapter.idAttribute=ALLOY_ID_DEFAULT,c[a]=l}if(e.columns=c,e.adapter.idAttribute){if(!_.contains(_.keys(e.columns),e.adapter.idAttribute))throw'config.adapter.idAttribute "'+e.adapter.idAttribute+'" not found in list of columns for table "'+i+'"\ncolumns: ['+_.keys(e.columns).join(",")+"]"}else{Ti.API.info('No config.adapter.idAttribute specified for table "'+i+'"'),Ti.API.info('Adding "'+ALLOY_ID_DEFAULT+'" to uniquely identify rows');var p=[],h=[];_.each(e.columns,function(e,t){h.push(t),p.push(t+" "+e)});var f=h.join(",");s.execute("ALTER TABLE "+i+" RENAME TO "+i+"_temp;"),s.execute("CREATE TABLE "+i+"("+p.join(",")+","+ALLOY_ID_DEFAULT+" TEXT UNIQUE);"),s.execute("INSERT INTO "+i+"("+f+","+ALLOY_ID_DEFAULT+") SELECT "+f+",CAST(_ROWID_ AS TEXT) FROM "+i+"_temp;"),s.execute("DROP TABLE "+i+"_temp;"),e.columns[ALLOY_ID_DEFAULT]="TEXT UNIQUE",e.adapter.idAttribute=ALLOY_ID_DEFAULT}s.close()}var _=require("alloy/underscore")._,backbone=require("alloy/backbone"),ALLOY_DB_DEFAULT="_alloy_",ALLOY_ID_DEFAULT="alloy_id",cache={config:{},Model:{}};module.exports.beforeModelCreate=function(e,t){if(cache.config[t])return cache.config[t];throw"No support for Titanium.Database in MobileWeb environment."},module.exports.afterModelCreate=function(e,t){return cache.Model[t]?cache.Model[t]:(e=e||{},e.prototype.idAttribute=e.prototype.config.adapter.idAttribute,Migrate(e),cache.Model[t]=e,e)},module.exports.sync=Sync;